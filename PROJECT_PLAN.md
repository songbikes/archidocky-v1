# Archidocky v1 - å»ºç¯‰è¡Œæ¥­å”ä½œå¹³å°è¦åŠƒæ–‡ä»¶

## é …ç›®æ¦‚è¿°

**é¡˜æ™¯**: æ‰“é€ å»ºç¯‰è¡Œæ¥­å°ˆæ¥­äººå£«çš„ä¸€ç«™å¼å”ä½œå¹³å°ï¼Œæå‡é …ç›®ç®¡ç†æ•ˆç‡ï¼Œç¸®çŸ­å­¸ç•Œèˆ‡æ¥­ç•Œçš„è·é›¢ã€‚

**ä½¿å‘½**: è®“å»ºç¯‰é …ç›®çš„æ–‡æª”ç®¡ç†ã€ç‰ˆæœ¬æ§åˆ¶ã€å°ˆæ¥­å”ä½œè®Šå¾—ç°¡å–®é«˜æ•ˆï¼Œä¸¦é€šé AI æŠ€è¡“æå‡å·¥ä½œæ•ˆç‡ã€‚

## ç›®æ¨™ç”¨æˆ¶ç¾¤é«”

### ä¸»è¦ç”¨æˆ¶

- **å»ºç¯‰å¸« (Architects)**
- **çµæ§‹å·¥ç¨‹å¸« (Structure Engineers)**
- **åœŸæœ¨å·¥ç¨‹å¸« (Civil Engineers)**
- **è¦åŠƒå¸« (Planners)**
- **æˆ¿åœ°ç”¢é–‹ç™¼å•† (Property Developers)**
- **æ™¯è§€å»ºç¯‰å¸« (Landscape Architects)**
- **æ¡æ¶è¨­è¨ˆå¸« (Truss Designers)**
- **å¸‚æ”¿å¯©æ‰¹å°ˆå“¡ (Council Processors)**

### æ¬¡è¦ç”¨æˆ¶

- **å»ºç¯‰ç›¸é—œå­¸ç”Ÿ** - å¹«åŠ©ä»–å€‘èˆ‡æ¥­ç•ŒéŠœæ¥
- **é …ç›®å”èª¿å“¡ (Coordinators)** - æ¸›å°‘æ–‡æ›¸è™•ç†å·¥ä½œ

## æ ¸å¿ƒåƒ¹å€¼ä¸»å¼µ

1. **ç‰ˆæœ¬æ§åˆ¶çµ±ä¸€åŒ–** - æ‰€æœ‰é …ç›®ç›¸é—œäººå“¡ç¸½æ˜¯èƒ½æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬çš„åœ–ç´™
2. **å·¥ä½œæµç¨‹è‡ªå‹•åŒ–** - æ¸›å°‘é‡è¤‡æ€§æ–‡æ›¸å·¥ä½œï¼Œæå‡æ•ˆç‡
3. **çŸ¥è­˜å…±äº«å¹³å°** - å»ºç«‹è¡Œæ¥­çŸ¥è­˜åº«ï¼Œä¿ƒé€²ç¶“é©—äº¤æµ
4. **AI è¼”åŠ©æ±ºç­–** - æ™ºèƒ½åˆ†ææ–‡æª”ã€æ³•è¦ï¼Œæä¾›å°ˆæ¥­å»ºè­°
5. **ç„¡ç¸«å”ä½œé«”é©—** - æ‰“ç ´å°ˆæ¥­å£å£˜ï¼Œæå‡é …ç›®æºé€šæ•ˆç‡

## æ ¸å¿ƒåŠŸèƒ½æ¨¡çµ„

### 1. ä¼æ¥­åœ–åº«ç®¡ç†ç³»çµ± (Company Detail Library)

**ç›®æ¨™**: æ¯å€‹å…¬å¸å»ºç«‹å°ˆå±¬çš„æ¨™æº–ç´°ç¯€åœ–åº«

**åŠŸèƒ½ç‰¹æ€§**:

- PDF æ ¼å¼çš„æ¨™æº–ç´°ç¯€åœ–å¡Šå„²å­˜
- åˆ†é¡æ¨™ç±¤ç³»çµ± (çµæ§‹ã€å»ºç¯‰ã€æ©Ÿé›»ç­‰)
- ç‰ˆæœ¬æ§åˆ¶å’Œæ›´æ–°é€šçŸ¥
- æœå°‹å’Œç¯©é¸åŠŸèƒ½
- åœ–å¡Šé è¦½å’Œæ‰¹é‡ç®¡ç†
- å…¬å¸é–“çš„åœ–åº«åˆ†äº«æ¬Šé™è¨­å®š

**æŠ€è¡“è€ƒé‡**:

- æª”æ¡ˆå„²å­˜: æ··åˆå„²å­˜ç­–ç•¥ (è¦‹ä¸‹æ–¹æª”æ¡ˆå„²å­˜æ¶æ§‹)
- åœ–åƒè™•ç†: React-PDF (Phase 1-3) â†’ Nutrient SDK (Phase 4+)
- æœå°‹: å…¨æ–‡æœå°‹ + æ¨™ç±¤ç³»çµ±

### æª”æ¡ˆå„²å­˜æ¶æ§‹ (Hybrid Storage Strategy)

#### å„²å­˜åˆ†å±¤ç­–ç•¥:

**ç›®æ¨™**: å¹³è¡¡æˆæœ¬èˆ‡æ•ˆèƒ½ï¼Œè™•ç†å¤§å‹å»ºç¯‰ PDF æª”æ¡ˆ

**Tier 1 - ç†±å„²å­˜ (Hot Storage)**: Convex File Storage

- **ç”¨é€”**: æœ€æ–°ç‰ˆæœ¬ + æœ€è¿‘ 30 å¤©çš„æª”æ¡ˆ
- **ç‰¹æ€§**: å¿«é€Ÿå­˜å–ã€å³æ™‚åŒæ­¥ã€å”ä½œç·¨è¼¯
- **é™åˆ¶**: å–®æª” 50MBï¼Œç¸½å®¹é‡ä¾æ–¹æ¡ˆé™åˆ¶
- **é©ç”¨**:
  - ç•¶å‰å·¥ä½œç‰ˆæœ¬
  - æ­£åœ¨ç·¨è¼¯çš„æ–‡æª”
  - é »ç¹å­˜å–çš„æª”æ¡ˆ

**Tier 2 - æº«å„²å­˜ (Warm Storage)**: AWS S3 Standard / Azure Blob Storage

- **ç”¨é€”**: 30-90 å¤©çš„æ­·å²ç‰ˆæœ¬
- **ç‰¹æ€§**: å¹³è¡¡çš„æˆæœ¬èˆ‡å­˜å–é€Ÿåº¦
- **é‚„åŸæ™‚é–“**: < 5 ç§’
- **é©ç”¨**:
  - è¿‘æœŸæ­·å²ç‰ˆæœ¬
  - å‚™ä»½æª”æ¡ˆ
  - å¯©è¨ˆè¿½è¹¤ç”¨é€”

**Tier 3 - å†·å„²å­˜ (Cold Storage)**: AWS S3 Glacier / Azure Archive Storage

- **ç”¨é€”**: 90 å¤©ä»¥ä¸Šçš„æ­·å²ç‰ˆæœ¬
- **ç‰¹æ€§**: ä½æˆæœ¬é•·æœŸä¿å­˜
- **é‚„åŸæ™‚é–“**: 1-5 åˆ†é˜ (Expedited), 3-5 å°æ™‚ (Standard)
- **é©ç”¨**:
  - é•·æœŸæ­¸æª”
  - æ³•è¦éµå¾ªè¦æ±‚
  - æ­·å²è¨˜éŒ„ä¿å­˜

#### ç‰ˆæœ¬ç®¡ç†ç­–ç•¥:

**è‡ªå‹•åˆ†å±¤è¦å‰‡**:

```javascript
// æª”æ¡ˆç”Ÿå‘½é€±æœŸç®¡ç†
const FILE_LIFECYCLE = {
  HOT: {
    retention: 30, // days
    storage: "convex",
    autoSync: true,
  },
  WARM: {
    retention: 90, // days
    storage: "s3-standard",
    autoSync: false,
  },
  COLD: {
    retention: "unlimited",
    storage: "s3-glacier",
    autoSync: false,
  },
};
```

**ç‰ˆæœ¬é‚„åŸæµç¨‹**:

1. ç”¨æˆ¶è«‹æ±‚é‚„åŸèˆŠç‰ˆæœ¬
2. ç³»çµ±æª¢æŸ¥æª”æ¡ˆä½ç½® (Hot/Warm/Cold)
3. å¾å°æ‡‰å„²å­˜å±¤å–å›æª”æ¡ˆ
4. å‰µå»ºæ–°çš„ç•¶å‰ç‰ˆæœ¬ï¼ˆä¿ç•™åŸæ­·å²ç‰ˆæœ¬ï¼‰
5. æ–°ç‰ˆæœ¬è‡ªå‹•é€²å…¥ Hot Storage
6. èˆŠçš„"ç•¶å‰ç‰ˆæœ¬"é™ç´šç‚ºæ­·å²ç‰ˆæœ¬

**æ™ºèƒ½é æ¸¬è¼‰å…¥**:

- åˆ†æç”¨æˆ¶å­˜å–æ¨¡å¼
- é å…ˆå°‡å¯èƒ½éœ€è¦çš„æª”æ¡ˆå¾ Cold ç§»è‡³ Warm
- æ¸›å°‘å¯¦éš›é‚„åŸç­‰å¾…æ™‚é–“

**æˆæœ¬å„ªåŒ–**:

```
ä¼°ç®—ï¼ˆæ¯æœˆï¼‰:
- Hot (Convex): $0.25/GB
- Warm (S3): $0.023/GB
- Cold (Glacier): $0.004/GB

ç¯„ä¾‹ï¼š1000å€‹ç”¨æˆ¶ï¼Œå¹³å‡æ¯å°ˆæ¡ˆ 50 å€‹ç‰ˆæœ¬
- ç•¶å‰ç‰ˆæœ¬ 10GB â†’ Convex: $2.5
- è¿‘æœŸç‰ˆæœ¬ 100GB â†’ S3: $2.3
- æ­·å²ç‰ˆæœ¬ 500GB â†’ Glacier: $2.0
ç¸½è¨ˆ: ~$7/æœˆ vs å…¨ Convex: ~$150/æœˆ
```

#### æŠ€è¡“å¯¦ç¾:

```typescript
// lib/storage/file-manager.ts
interface FileVersion {
  id: string;
  version: number;
  storageLayer: "hot" | "warm" | "cold";
  location: string;
  size: number;
  createdAt: Date;
  isCurrent: boolean;
}

async function restoreVersion(versionId: string) {
  const version = await getVersion(versionId);

  // æ ¹æ“šå„²å­˜å±¤è™•ç†
  switch (version.storageLayer) {
    case "hot":
      return await convex.storage.get(version.location);
    case "warm":
      return await s3.getObject(version.location);
    case "cold":
      // è«‹æ±‚å¿«é€Ÿå–å›
      await glacier.initiateRetrievalExpedited(version.location);
      // é€šçŸ¥ç”¨æˆ¶é è¨ˆç­‰å¾…æ™‚é–“
      return { status: "restoring", eta: "1-5 minutes" };
  }
}
```

### 2. æ™ºèƒ½ PDF å”ä½œå¹³å° (Smart PDF Collaboration)

**ç›®æ¨™**: æä¾›å®Œæ•´çš„ç·šä¸Š PDF ç·¨è¼¯å’Œå”ä½œé«”é©—

#### PDF æ•´åˆæ–¹æ¡ˆ - éšæ®µæ€§ç­–ç•¥:

**Phase 1-3 (MVP): React-PDF**

**é¸æ“‡åŸå› **:

- âœ… **é›¶æˆæœ¬** - å®Œå…¨é–‹æº (MIT License)
- âœ… **å¿«é€Ÿæ•´åˆ** - 1-2 å¤©å®ŒæˆåŸºæœ¬åŠŸèƒ½
- âœ… **è¶³å¤  MVP** - æ¶µè“‹æª¢è¦–ã€è¨»è§£ã€æ–‡å­—é¸å–éœ€æ±‚
- âœ… **ç¤¾ç¾¤æ´»èº** - 10.7k GitHub starsï¼ŒæŒçºŒç¶­è­·
- âœ… **Next.js å‹å–„** - å®˜æ–¹ç¯„ä¾‹å®Œæ•´

**æŠ€è¡“è¦æ ¼**:

```bash
npm install react-pdf pdfjs-dist
```

**æ ¸å¿ƒåŠŸèƒ½æ”¯æ´**:

- âœ… é«˜æ€§èƒ½ PDF æ¸²æŸ“ (WebAssembly)
- âœ… æ–‡å­—å±¤èˆ‡è¨»è§£å±¤
- âœ… ç¸®æ”¾ã€æ—‹è½‰ã€æœå°‹
- âœ… å¤šé é¢å°èˆª
- âœ… é›¢ç·šæ”¯æ´
- âš ï¸ åŸºç¤è¨»è§£é¡¯ç¤ºï¼ˆç„¡ç·¨è¼¯ï¼‰
- âŒ å³æ™‚å”ä½œï¼ˆéœ€ Convex è‡ªè¡Œå¯¦ä½œï¼‰
- âŒ æ–‡å­—ç·¨è¼¯
- âŒ é›»å­ç°½å

**Phase 4+ (é€²éšåŠŸèƒ½): è©•ä¼° Nutrient SDK**

**å‡ç´šæ™‚æ©Ÿ** (ç•¶ä»¥ä¸‹ä»»ä¸€æ¢ä»¶æˆç«‹):

1. ä»˜è²»ç”¨æˆ¶é”åˆ° **50+ å…¬å¸**
2. ç”¨æˆ¶å¼·çƒˆè¦æ±‚ã€Œå³æ™‚å”ä½œç·¨è¼¯ã€
3. éœ€ç¬¦åˆ Council æ•¸ä½ç°½åè¦ç¯„
4. AI åŠŸèƒ½éœ€æ·±åº¦æ•´åˆ PDF å·¥ä½œæµ

**Nutrient SDK å„ªå‹¢**:

- âœ… **å®Œæ•´ PDF ç”Ÿå‘½é€±æœŸ** - æª¢è¦–ã€ç·¨è¼¯ã€ç°½åã€æ¯”å°
- âœ… **å³æ™‚å”ä½œ** - å…§å»º Instant Collaboration
- âœ… **17 ç¨®è¨»è§£é¡å‹** - å°ˆæ¥­æ¨™è¨»å·¥å…·
- âœ… **æ–‡å­—ç·¨è¼¯** - ç›´æ¥ä¿®æ”¹ PDF å…§å®¹
- âœ… **é›»å­+æ•¸ä½ç°½å** - Council åˆè¦
- âœ… **æ–‡ä»¶æ¯”å°** - ç‰ˆæœ¬å·®ç•°åˆ†æ
- âœ… **AI æ•´åˆ** - å…§å»º AI Assistant
- âœ… **ä¼æ¥­ç´šèªè­‰** - SOC 2 Type 2
- âœ… **PDFium å¼•æ“** - Chrome/Edge åŒæ¬¾
- ğŸ’° **å•†æ¥­æˆæ¬Š** - éœ€è¯ç¹«å ±åƒ¹

**æŠ€è¡“è¦æ ¼**:

```bash
npm install pspdfkit
# æˆ–ä½¿ç”¨ Cloud API (å…ç¶­è­·åŸºç¤è¨­æ–½)
```

**é·ç§»ç­–ç•¥**:

- React-PDF èˆ‡ Nutrient éƒ½æ˜¯ React çµ„ä»¶
- é·ç§»æˆæœ¬ä½ï¼Œä¸»è¦æ˜¯ API å·®ç•°
- å¯é€æ­¥é·ç§»ï¼ˆå…ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå†æ“´å±•ï¼‰

**æˆæœ¬æ•ˆç›Šåˆ†æ**:

```
React-PDF (Phase 1-3):
- æˆæ¬Šè²»ç”¨: $0
- é–‹ç™¼æ™‚é–“: 2-3 å¤©
- é™åˆ¶: ç„¡é€²éšç·¨è¼¯/å”ä½œ

Nutrient (Phase 4+):
- æˆæ¬Šè²»ç”¨: å¾…æ´½è«‡ï¼ˆä¼° $500-2000/æœˆï¼‰
- ç¯€çœé–‹ç™¼: 6-12 å€‹æœˆå·¥ç¨‹æ™‚é–“
- ROI: å®˜æ–¹æ•¸æ“šé¡¯ç¤º 63% å·¥ç¨‹æˆæœ¬é™ä½
```

#### æ ¸å¿ƒåŠŸèƒ½:

**PDF ç€è¦½èˆ‡ç®¡ç†**

- é«˜æ€§èƒ½ç·šä¸Š PDF ç€è¦½å™¨
- å¤šé é¢ç¸®åœ–å°èˆª
- ç¸®æ”¾ã€æ—‹è½‰ã€å…¨è¢å¹•æª¢è¦–
- é é¢é‡æ–°æ’åºå’Œç®¡ç†

**æ¨™è¨»èˆ‡å”ä½œ**

- æ–‡å­—æ¨™è¨»ã€é«˜äº®æ¨™è¨˜
- å¹¾ä½•åœ–å½¢æ¨™è¨» (ç·šæ¢ã€ç®­é ­ã€çŸ©å½¢)
- ä¾¿ç°½è©•è«–ç³»çµ±
- å”ä½œè€…å³æ™‚æ¨™è¨»åŒæ­¥
- æ¨™è¨»æ­·å²å’Œç‰ˆæœ¬è¿½è¹¤

**æ–‡æª”ç·¨è¼¯**

- é é¢åç¨±è‡ªè¨‚
- è·¨é é¢è¶…é€£çµå»ºç«‹
- é é¢è¤‡è£½å’Œæ–°å¢
- é é¢åˆªé™¤å’Œé‡çµ„
- é›»å­ç°½ååŠŸèƒ½

**ç´°ç¯€åœ–å¡Šæ•´åˆ**

- å¾å…¬å¸åœ–åº«æ‹–æ‹½æ’å…¥ç´°ç¯€åœ–å¡Š
- è‡ªç”±èª¿æ•´åœ–å¡Šä½ç½®å’Œå¤§å°
- åœ–å¡Šå±¤ç´šç®¡ç†
- åœ–å¡Šèˆ‡åŸå§‹ PDF çš„èåˆ

**æŠ€è¡“å¯¦ç¾**:

**Phase 1-3 å¯¦ä½œ (React-PDF)**:

```typescript
// components/PDFViewer.tsx
'use client';
import { Document, Page } from 'react-pdf';
import { pdfjs } from 'react-pdf';
import 'react-pdf/dist/Page/AnnotationLayer.css';
import 'react-pdf/dist/Page/TextLayer.css';

pdfjs.GlobalWorkerOptions.workerSrc = new URL(
  'pdfjs-dist/build/pdf.worker.min.mjs',
  import.meta.url,
).toString();

export function PDFViewer({ fileUrl }: { fileUrl: string }) {
  const [numPages, setNumPages] = useState<number>();
  const [pageNumber, setPageNumber] = useState(1);

  return (
    <Document
      file={fileUrl}
      onLoadSuccess={({ numPages }) => setNumPages(numPages)}
      options={{
        cMapUrl: '/cmaps/',
        standardFontDataUrl: '/standard_fonts/',
      }}
    >
      {Array.from(new Array(numPages), (el, index) => (
        <Page
          key={`page_${index + 1}`}
          pageNumber={index + 1}
          renderTextLayer={true}
          renderAnnotationLayer={true}
          scale={scale}
        />
      ))}
    </Document>
  );
}
```

**å”ä½œåŠŸèƒ½ (Convex å¯¦ä½œ)**:

```typescript
// convex/annotations.ts
export const addAnnotation = mutation({
  args: {
    pdfId: v.id("pdfs"),
    pageNumber: v.number(),
    position: v.object({ x: v.number(), y: v.number() }),
    content: v.string(),
    type: v.string(), // 'comment', 'highlight', 'drawing'
  },
  handler: async (ctx, args) => {
    const annotationId = await ctx.db.insert("annotations", {
      ...args,
      createdAt: Date.now(),
      createdBy: ctx.auth.getUserIdentity()?.subject,
    });

    // å³æ™‚é€šçŸ¥å…¶ä»–å”ä½œè€…
    await ctx.db.insert("notifications", {
      type: "new_annotation",
      targetUsers: await getProjectMembers(args.pdfId),
      data: { annotationId, pageNumber: args.pageNumber },
    });

    return annotationId;
  },
});

// å³æ™‚è¨‚é–±è¨»è§£æ›´æ–°
export const subscribeAnnotations = query({
  args: { pdfId: v.id("pdfs") },
  handler: async (ctx, args) => {
    return await ctx.db
      .query("annotations")
      .filter((q) => q.eq(q.field("pdfId"), args.pdfId))
      .collect();
  },
});
```

**Phase 4+ å‡ç´š (Nutrient)**:

```typescript
// components/PDFViewerPro.tsx
import PSPDFKit from "pspdfkit";

export async function PDFViewerPro({ fileUrl }: { fileUrl: string }) {
  useEffect(() => {
    PSPDFKit.load({
      container: "#pspdfkit",
      document: fileUrl,
      licenseKey: process.env.NEXT_PUBLIC_PSPDFKIT_KEY,

      // å³æ™‚å”ä½œ
      instant: true,
      instantJSON: {
        documentId: documentId,
        serverUrl: "wss://your-instant-server.com",
      },

      // è‡ªè¨‚å·¥å…·åˆ—
      toolbarItems: [
        ...PSPDFKit.defaultToolbarItems,
        { type: "custom", title: "AI Assistant", onPress: openAIPanel },
      ],

      // é›»å­ç°½å
      signatureOptions: {
        enabled: true,
        appearance: "council-compliant",
      },
    });
  }, []);
}
```

**æª”æ¡ˆè™•ç†**: PDF-lib (å…©éšæ®µé€šç”¨)
**ç•«å¸ƒæ“ä½œ**: Fabric.js æˆ– Konva.js (Phase 1-3)
**å³æ™‚å”ä½œ**: Convex Real-time (Phase 1-3) / Nutrient Instant (Phase 4+)

### 2.5. æ™ºèƒ½åœ°å€åˆ†æèˆ‡æ³•è¦æŸ¥è©¢ç³»çµ± (Smart Address Analysis & Compliance Lookup)

**ç›®æ¨™**: æ ¹æ“šé …ç›®åœ°å€è‡ªå‹•ç²å– Council åˆ†å€ã€BRANZ æ°£å€™æ•¸æ“šåŠç›¸é—œå»ºç¯‰æ³•è¦

#### æ ¸å¿ƒåŠŸèƒ½ï¼š

**A. Council åˆ†å€è‡ªå‹•æŸ¥è©¢ (Automated Zoning Lookup)**

**æ”¯æ´çš„ Councilï¼ˆPhase 1-3 é€æ­¥æ“´å±•ï¼‰**:

- Auckland Council - Unitary Plan
- Wellington City Council - District Plan
- Christchurch City Council - District Plan
- Queenstown Lakes District Council
- Hamilton City Council
- å…¶ä»–ä¸»è¦åŸå¸‚ Council...

**æŸ¥è©¢æµç¨‹**:

```
ç”¨æˆ¶è¼¸å…¥é …ç›®åœ°å€
    â†“
åœ°å€æ¨™æº–åŒ– & é©—è­‰ï¼ˆNZ Post API / Google Mapsï¼‰
    â†“
åœ°å€ â†’ GPS åº§æ¨™è½‰æ›
    â†“
åå‘å·¥ç¨‹ Council GIS ç³»çµ±
    â”œâ”€ Auckland: Unitary Plan Viewer API
    â”œâ”€ Wellington: District Plan GIS
    â”œâ”€ Christchurch: Planning Maps API
    â””â”€ å…¶ä»–: å„ Council ArcGIS/MapServer
    â†“
ç²å–åˆ†å€è³‡è¨Š
    â”œâ”€ Zone Code (å¦‚: MHU, CCZ, RS)
    â”œâ”€ Zone Name (å¦‚: Mixed Housing Urban)
    â”œâ”€ Overlay Zones (å¦‚: Heritage, Volcanic)
    â”œâ”€ Precincts (å¦‚: Special Character)
    â””â”€ Height Limits
    â†“
è‡ªå‹•é¡¯ç¤ºåœ¨é …ç›®å„€è¡¨æ¿
```

**æŠ€è¡“å¯¦ç¾ - åå‘å·¥ç¨‹æ–¹æ³•**:

**1. Auckland Council ç¯„ä¾‹**:

```typescript
// lib/council/auckland-zone-lookup.ts

interface AucklandZoneResult {
  zoneCode: string; // "MHU"
  zoneName: string; // "Mixed Housing Urban Zone"
  overlays: string[]; // ["Historic Heritage", "Flood"]
  heightLimit: number; // 11 metres
  precinct?: string;
  coordinates: { lat: number; lng: number };
}

async function getAucklandZone(address: string): Promise<AucklandZoneResult> {
  // Step 1: åœ°å€ â†’ åº§æ¨™ï¼ˆAuckland Council Geocoderï¼‰
  const geocodeResponse = await fetch(
    "https://maps.aucklandcouncil.govt.nz/arcgis/rest/services/Locators/ACAddress/GeocodeServer/findAddressCandidates",
    {
      method: "POST",
      body: new URLSearchParams({
        SingleLine: address,
        f: "json",
        outSR: "2193", // NZTMåº§æ¨™ç³»çµ±
        maxLocations: "1",
      }),
    }
  );

  const { candidates } = await geocodeResponse.json();
  const location = candidates[0].location; // { x, y } in NZTM

  // Step 2: åº§æ¨™ â†’ Zone è³‡è¨Šï¼ˆUnitary Plan Viewer APIï¼‰
  const zoneResponse = await fetch(
    "https://unitaryplan.aucklandcouncil.govt.nz/arcgis/rest/services/PlanViewer/MapServer/identify?" +
      new URLSearchParams({
        geometry: `${location.x},${location.y}`,
        geometryType: "esriGeometryPoint",
        layers: "all:20,all:21,all:22", // Zones, Height, Overlays
        tolerance: "1",
        mapExtent: `${location.x - 100},${location.y - 100},${location.x + 100},${location.y + 100}`,
        imageDisplay: "1024,768,96",
        returnGeometry: "false",
        f: "json",
      })
  );

  const zoneData = await zoneResponse.json();

  // Step 3: è§£æä¸¦è¿”å›çµæœ
  return parseAucklandZoneData(zoneData.results);
}

// åº§æ¨™ç³»çµ±è½‰æ› (NZTM â†’ WGS84)
function convertNZTMtoLatLng(x: number, y: number) {
  const proj4 = require("proj4");
  const nztm =
    "+proj=tmerc +lat_0=0 +lon_0=173 +k=0.9996 +x_0=1600000 +y_0=10000000 +ellps=GRS80";
  const wgs84 = "+proj=longlat +datum=WGS84";
  const [lng, lat] = proj4(nztm, wgs84, [x, y]);
  return { lat, lng };
}
```

**2. å¤š Council çµ±ä¸€ä»‹é¢**:

```typescript
// lib/council/unified-zone-lookup.ts

interface UnifiedZoneResult {
  council: string;
  zoneCode: string;
  zoneName: string;
  restrictions: {
    heightLimit?: number;
    siteCoverage?: number;
    setbacks?: { front: number; side: number; rear: number };
    buildingTypes?: string[];
  };
  overlays: string[];
  sourceUrl: string;
  lastUpdated: Date;
}

async function getZoneByAddress(address: string): Promise<UnifiedZoneResult> {
  // 1. è­˜åˆ¥ Council
  const council = await identifyCouncil(address);

  // 2. è·¯ç”±åˆ°å°æ‡‰çš„æŸ¥è©¢å‡½æ•¸
  switch (council) {
    case "auckland":
      return await getAucklandZone(address);
    case "wellington":
      return await getWellingtonZone(address);
    case "christchurch":
      return await getChristchurchZone(address);
    default:
      return await getFallbackZone(address); // Manual lookup
  }
}
```

**B. BRANZ æ°£å€™èˆ‡ç’°å¢ƒæ•¸æ“šè‡ªå‹•æŸ¥è©¢**

**BRANZ æ•¸æ“šæº**:

- Erosion Zone (ä¾µè•å€)
- Earthquake Zone (åœ°éœ‡å€)
- Wind Zone (é¢¨å€)
- Wind Region (é¢¨åŸŸ)
- Lee Zone (èƒŒé¢¨å€)
- Climate Zone (æ°£å€™å€)
- Snow Load Zone (é›ªè¼‰å€)
- Rainfall Zone (é™é›¨å€)

**æŸ¥è©¢æµç¨‹**:

```typescript
// lib/branz/climate-data-lookup.ts

interface BRANZClimateData {
  address: string;
  coordinates: { lat: number; lng: number };
  zones: {
    erosion: "Very High" | "High" | "Medium" | "Low";
    earthquake: "Zone A" | "Zone B" | "Zone C";
    wind: "W1" | "W2" | "W3" | "W4";
    windRegion: "A" | "B" | "C";
    leeZone: boolean;
    climate: "Zone 1" | "Zone 2" | "Zone 3";
    snowLoad?: number; // kPa
    rainfall?: number; // mm/year
  };
  buildingCodeReferences: {
    NZS3604: string[]; // ç›¸é—œæ¢æ¬¾
    E2AS1: string[]; // å¤–éƒ¨é˜²æ°´æ¨™æº–
    B1VM1: string[]; // çµæ§‹æ¨™æº–
  };
}

async function getBRANZData(coordinates: {
  lat: number;
  lng: number;
}): Promise<BRANZClimateData> {
  // æ–¹æ³• 1: BRANZ å®˜æ–¹ APIï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  // æ–¹æ³• 2: åå‘å·¥ç¨‹ BRANZ Maps
  // æ–¹æ³• 3: é å»ºè³‡æ–™åº« + åœ°ç†æ’å€¼

  const branzResponse = await fetch(
    "https://branzdata.example.com/api/climate-zones",
    {
      params: {
        lat: coordinates.lat,
        lng: coordinates.lng,
      },
    }
  );

  return await branzResponse.json();
}
```

**åå‘å·¥ç¨‹ BRANZ Maps**:

```typescript
// lib/branz/reverse-engineer-maps.ts

async function scrapeBRANZMaps(coordinates: { lat: number; lng: number }) {
  // 1. è¼‰å…¥ BRANZ äº’å‹•åœ°åœ–
  const mapUrl = `https://branz.co.nz/climate-zones/map?lat=${coordinates.lat}&lng=${coordinates.lng}`;

  // 2. ä½¿ç”¨ Puppeteer æ¨¡æ“¬ç€è¦½å™¨
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  await page.goto(mapUrl);

  // 3. æ“·å–åœ°åœ–åœ–å±¤æ•¸æ“š
  const zoneData = await page.evaluate(() => {
    // åŸ·è¡Œç¶²é å…§çš„ JavaScript ç²å–åœ–å±¤è³‡è¨Š
    return window.mapLayers.getZoneInfo();
  });

  await browser.close();

  return zoneData;
}
```

**C. Council è¡¨æ ¼è‡ªå‹•å¡«å¯«ï¼ˆæ•´åˆåŠŸèƒ½ï¼‰**

ç•¶ç”¨æˆ¶å‰µå»ºé …ç›®æ™‚ï¼š

```typescript
// convex/projects.ts

export const createProject = mutation({
  args: {
    name: v.string(),
    siteAddress: v.string(),
    // ...
  },
  handler: async (ctx, args) => {
    // 1. å‰µå»ºé …ç›®
    const projectId = await ctx.db.insert("projects", args);

    // 2. è‡ªå‹•æŸ¥è©¢ Zone å’Œæ°£å€™æ•¸æ“š
    const zoneData = await getZoneByAddress(args.siteAddress);
    const climateData = await getBRANZData(zoneData.coordinates);

    // 3. å„²å­˜åˆ°é …ç›®
    await ctx.db.patch(projectId, {
      zoneInfo: zoneData,
      climateData: climateData,
    });

    // 4. è‡ªå‹•ç”Ÿæˆ Council è¡¨æ ¼ï¼ˆå·²é å¡«åœ°å€ï¼‰
    const forms = [
      "AC2326 - Producer Statement Construction",
      "AC1011 - Lodgement Checklist Residential",
    ];

    for (const formName of forms) {
      const filledPDF = await autoFillCouncilForm(formName, {
        address: args.siteAddress,
        zone: zoneData.zoneName,
        // ... å…¶ä»–è³‡æ–™
      });

      // å„²å­˜ PDF åˆ°é …ç›®
      const storageId = await ctx.storage.store(filledPDF);
      await ctx.db.insert("documents", {
        projectId,
        name: formName,
        storageId,
        autoGenerated: true,
      });
    }

    return projectId;
  },
});
```

**D. é …ç›®å„€è¡¨æ¿é¡¯ç¤º**

```tsx
// components/project-dashboard.tsx

<ProjectDashboard>
  <Section title="Site Information">
    <AddressCard address={project.siteAddress} />

    <ZoneCard>
      <Badge>{zoneInfo.council}</Badge>
      <h3>{zoneInfo.zoneName}</h3>
      <p>Code: {zoneInfo.zoneCode}</p>

      <Restrictions>
        <Item>Height Limit: {zoneInfo.restrictions.heightLimit}m</Item>
        <Item>Site Coverage: {zoneInfo.restrictions.siteCoverage}%</Item>
        <Item>
          Setbacks: F{setbacks.front}m / S{setbacks.side}m / R{setbacks.rear}m
        </Item>
      </Restrictions>

      {zoneInfo.overlays.length > 0 && (
        <Overlays>
          {zoneInfo.overlays.map((overlay) => (
            <Badge variant="warning">{overlay}</Badge>
          ))}
        </Overlays>
      )}
    </ZoneCard>

    <ClimateCard>
      <h3>BRANZ Climate Data</h3>
      <Grid>
        <DataItem label="Wind Zone" value={climateData.zones.wind} />
        <DataItem
          label="Earthquake Zone"
          value={climateData.zones.earthquake}
        />
        <DataItem label="Erosion Zone" value={climateData.zones.erosion} />
        <DataItem label="Climate Zone" value={climateData.zones.climate} />
      </Grid>

      <Alert>
        Relevant Building Code:{" "}
        {climateData.buildingCodeReferences.NZS3604.join(", ")}
      </Alert>
    </ClimateCard>
  </Section>

  <Section title="Auto-Generated Documents">
    <DocumentList>
      {autoGeneratedForms.map((form) => (
        <DocumentCard
          name={form.name}
          status="Pre-filled with site data"
          onView={() => openPDF(form.id)}
        />
      ))}
    </DocumentList>
  </Section>
</ProjectDashboard>
```

#### æŠ€è¡“æ¶æ§‹ï¼š

**è³‡æ–™å¿«å–ç­–ç•¥**:

```typescript
// lib/cache/zone-cache.ts

// å¿«å– Zone æŸ¥è©¢çµæœï¼ˆé¿å…é‡è¤‡è«‹æ±‚ Council APIï¼‰
const zoneCache = new Map<string, { data: ZoneResult; expiry: Date }>();

async function getCachedZone(address: string) {
  const cached = zoneCache.get(address);
  if (cached && cached.expiry > new Date()) {
    return cached.data;
  }

  const freshData = await getZoneByAddress(address);
  zoneCache.set(address, {
    data: freshData,
    expiry: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 å¤©
  });

  return freshData;
}
```

**éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ–¹æ¡ˆ**:

```typescript
async function getZoneWithFallback(address: string) {
  try {
    // å˜—è©¦è‡ªå‹•æŸ¥è©¢
    return await getZoneByAddress(address);
  } catch (error) {
    // é™ç´šï¼šæä¾›æ‰‹å‹•è¼¸å…¥ä»‹é¢
    return {
      status: "manual_input_required",
      message: "Unable to auto-detect zone. Please select manually.",
      manualOptions: await getCouncilZoneList(),
    };
  }
}
```

**ç›£æ¸¬èˆ‡ç¶­è­·**:

- å®šæœŸé©—è­‰ API ç«¯é»æ˜¯å¦è®Šæ›´
- è‡ªå‹•åŒ–æ¸¬è©¦å·²çŸ¥åœ°å€çš„ Zone æº–ç¢ºæ€§
- Council è¦å‰‡è®Šæ›´é€šçŸ¥ç³»çµ±

#### æ³•å¾‹èˆ‡å…è²¬è²æ˜ï¼š

**é‡è¦è²æ˜**ï¼ˆé¡¯ç¤ºåœ¨æ¯å€‹æŸ¥è©¢çµæœï¼‰:

> âš ï¸ **Disclaimer**: This information is automatically retrieved from council databases and BRANZ data sources for reference purposes only. Always verify with the relevant council and consult with licensed professionals. Archidocky is not responsible for any inaccuracies or outdated information.

#### å„ªå‹¢èˆ‡å·®ç•°åŒ–ï¼š

âœ… **ç¯€çœæ™‚é–“**: è‡ªå‹•æŸ¥è©¢å–ä»£æ‰‹å‹•æŸ¥æ‰¾  
âœ… **æ¸›å°‘éŒ¯èª¤**: ç›´æ¥å¾å®˜æ–¹ä¾†æºç²å–è³‡æ–™  
âœ… **å³æ™‚æ›´æ–°**: æ¯æ¬¡æŸ¥è©¢éƒ½æ˜¯æœ€æ–°è³‡æ–™  
âœ… **æ•´åˆé«”é©—**: Zone + æ°£å€™æ•¸æ“š + è¡¨æ ¼å¡«å¯«ä¸€æ¬¡å®Œæˆ  
âœ… **ç«¶çˆ­å„ªå‹¢**: å¸‚å ´ä¸Šå°‘æœ‰å¹³å°æä¾›æ­¤æ•´åˆåŠŸèƒ½

---

### 3. AI æ™ºèƒ½åŠ©æ‰‹ç³»çµ± (AI-Powered Assistant)

**ç›®æ¨™**: æä¾›å»ºç¯‰å°ˆæ¥­çš„ AI è¼”åŠ©æœå‹™

#### æ–‡æª”æ™ºèƒ½åˆ†æ:

**åœ–ç´™è§£è®€**

- OCR æ–‡å­—è­˜åˆ¥å’Œçµæ§‹åŒ–
- åœ–ç´™å…ƒç´ è‡ªå‹•æ¨™è¨˜ (å°ºå¯¸ã€ç¬¦è™Ÿã€è¨»è§£)
- è¨­è¨ˆè¦ç¯„ç¬¦åˆæ€§æª¢æŸ¥
- åœ–ç´™é–“ä¸€è‡´æ€§é©—è­‰

**æ–‡ä»¶è™•ç†**

- æŠ€è¡“è¦ç¯„è‡ªå‹•æ‘˜è¦
- åˆç´„æ¢æ¬¾é‡é»æå–
- æœƒè­°è¨˜éŒ„è‡ªå‹•æ•´ç†
- é …ç›®é€²åº¦å ±å‘Šç”Ÿæˆ

**æ³•è¦åˆè¦æ€§æª¢æŸ¥**

- å»ºç¯‰æ³•è¦è‡ªå‹•æ¯”å°
- åœ°æ–¹æ³•è¦ç¬¦åˆæ€§åˆ†æ
- è¨­è¨ˆä¿®æ”¹å»ºè­°ç”Ÿæˆ
- æ³•è¦æ›´æ–°é€šçŸ¥

#### RFI æ™ºèƒ½è™•ç†èˆ‡å›è¦†ç³»çµ±:

**A. å¤šæ ¼å¼ RFI è§£æå¼•æ“**

**æ”¯æ´çš„è¼¸å…¥æ ¼å¼**:

- Email å…§æ–‡ï¼ˆGmail/Outlook APIï¼‰
- Word æ–‡æª”ï¼ˆ.docxï¼‰
- PDF æ–‡ä»¶ï¼ˆæ–‡å­—å‹ + æƒæå‹ OCRï¼‰
- æˆªåœ–/åœ–ç‰‡ï¼ˆVision AI + OCRï¼‰

**æ™ºèƒ½å…§å®¹æ¸…ç†**:

```typescript
// æ ¸å¿ƒåŸå‰‡
{
  "preserveOriginal": true,  // ä¿ç•™åŸæ–‡ï¼ˆå«æ‹¼éŸ³/æ–‡æ³•éŒ¯èª¤ï¼‰
  "formatCleaning": true,    // æ¸…ç†æ ¼å¼
  "duplicateDetection": true, // åµæ¸¬é‡è¤‡å•é¡Œ
  "categoryTagging": true,   // å•é¡Œåˆ†é¡
  "extractMedia": true       // æå–åœ–ç‰‡å’Œé€£çµ
}
```

**AI è™•ç†æµç¨‹**:

1. æ¥æ”¶å¤šç¨®æ ¼å¼çš„ RFI æ–‡ä»¶
2. æå–å•é¡Œä¸¦ä¿ç•™åŸå§‹æªè¾­
3. æ ¼å¼åŒ–æ’ç‰ˆã€ç·¨è™Ÿ
4. åµæ¸¬ä¸¦æ¨™è¨˜é‡è¤‡å•é¡Œ
5. è‡ªå‹•åˆ†é¡ï¼ˆè¨­è¨ˆã€åˆè¦ã€æ–‡ä»¶ç­‰ï¼‰
6. æå–å…§åµŒåœ–ç‰‡å’Œç¶²å€
7. ç”Ÿæˆçµæ§‹åŒ–ç·šä¸Šæ–‡æª”

**æŠ€è¡“æ£§**:

- Word è§£æ: mammoth.js
- PDF è§£æ: pdf-parse + React-PDF (Phase 1-3) / Nutrient Document API (Phase 4+)
- OCR: Google Document AI / Tesseract.js
- Vision AI: Google Gemini 2.0 Flash
- æ–‡ä»¶è™•ç†: LangChain

**B. Cover Letter ç”Ÿæˆç³»çµ±ï¼ˆä¸»è¦ç”¢å‡ºï¼‰**

**A4 ç›´å¼å°ˆæ¥­æ–‡æª”ç‰¹æ€§**:

- å…¬å¸æŠ¬é ­ï¼ˆLogo + è¯çµ¡è³‡è¨Šï¼‰
- æ”¶ä»¶äººè³‡è¨Šï¼ˆProcessor + Councilï¼‰
- é …ç›®åƒè€ƒè³‡è¨Šï¼ˆåœ°å€ã€Consent Numberï¼‰
- é€é¡Œå›ç­”æ ¼å¼
  - ä¿ç•™åŸå§‹å•é¡Œï¼ˆå«éŒ¯èª¤ï¼‰
  - æ ¼å¼åŒ–å›ç­”
  - å…§åµŒåœ–ç‰‡é™„ä»¶
- å°ˆæ¥­çµå°¾èˆ‡ç°½å
- å³æ™‚ PDF é è¦½
- ä¸€éµä¸‹è¼‰

**ç”ŸæˆæŠ€è¡“**:

```typescript
// ä½¿ç”¨ React-PDF (@react-pdf/renderer) æˆ– PDFKit
interface CoverLetterData {
  company: CompanyHeader;
  processor: ProcessorInfo;
  project: ProjectDetails;
  responses: QuestionResponse[];
  signature: SignatureBlock;
}

// Phase 1-3: @react-pdf/renderer (ç”Ÿæˆ PDF)
// Phase 4+: å¯é¸ç”¨ Nutrient Document Generation API
generateCoverLetter(data) â†’ PDF Buffer
```

**ç”¨é€”**:

- ä¸‹è¼‰å¾Œä¸Šå‚³åˆ° Council Portal
- åˆ—å°å­˜æª”
- éƒµå¯„çµ¦ Councilï¼ˆå¦‚éœ€è¦ï¼‰

**C. ç·šä¸Šå›è¦†ç·¨è¼¯å™¨**

**åŠŸèƒ½ç‰¹æ€§**:

- é›™é¢æ¿ä½ˆå±€ï¼ˆç·¨è¼¯å™¨ + PDF é è¦½ï¼‰
- æ¯å€‹å•é¡Œç¨ç«‹å›ç­”å€
- Rich Text Editorï¼ˆæ ¼å¼åŒ–æ–‡å­—ï¼‰
- åœ–ç‰‡ä¸Šå‚³èˆ‡ç®¡ç†
- AI è¼”åŠ©å›ç­”å»ºè­°
- è‰ç¨¿è‡ªå‹•ä¿å­˜
- å³æ™‚ PDF é è¦½æ›´æ–°

**ç”¨æˆ¶é«”é©—**:

```tsx
<RFICoverLetterEditor>
  <LeftPanel>
    <CompanyHeaderEditor />
    {questions.map((q) => (
      <QuestionBlock>
        <OriginalQuestion readOnly>{q.text}</OriginalQuestion>
        <ResponseEditor placeholder="Enter response..." />
        <ImageUploader />
      </QuestionBlock>
    ))}
    <SignatureBlock />
  </LeftPanel>

  <RightPanel>
    <LivePDFPreview />
  </RightPanel>

  <Actions>
    <DownloadPDF />
    <SaveDraft />
    <SendNotifications />
  </Actions>
</RFICoverLetterEditor>
```

**D. é€šçŸ¥ç³»çµ±ï¼ˆè¼”åŠ©åŠŸèƒ½ï¼‰**

**ç°¡åŒ–çš„åœ˜éšŠé€šçŸ¥**:

- åƒ…é™å¹³å°å…§çš„å°ˆæ¡ˆæˆå“¡
- ç«™å…§é€šçŸ¥ ï¿½ï¿½ï¿½
- Email æé†’ï¼ˆå¯é¸ï¼‰
- ç°¡å–®è¨Šæ¯ï¼š"RFI å›è¦†å·²æäº¤"

**é€šçŸ¥æµç¨‹**:

```typescript
// 1. é¸æ“‡è¦é€šçŸ¥çš„åœ˜éšŠæˆå“¡
selectRecipients(projectMembers);

// 2. ç™¼é€ç«™å…§é€šçŸ¥
createNotification({
  type: "rfi_response",
  message: "RFI response submitted to council",
  link: "/projects/{id}/rfis/{rfiId}",
});

// 3. å¯é¸ï¼šEmail æé†’
sendEmail({
  subject: "RFI Response Submitted",
  body: simpleTemplate(message, projectLink),
});
```

**é€šçŸ¥ä»‹é¢**:

- é ‚éƒ¨å°èˆªæ¬„é€šçŸ¥éˆ´éº
- æœªè®€æ•¸é‡å¾½ç« 
- ä¸‹æ‹‰å¼é€šçŸ¥åˆ—è¡¨
- é»æ“Šè·³è½‰åˆ°ç›¸é—œ RFI

**E. æœªä¾†æ“´å±•ï¼šCouncil Portal æ•´åˆ**

**é¡˜æ™¯**:

- æˆç‚ºæ¥­ç•Œçµ±ä¸€çš„ RFI å›è¦†å¹³å°
- ç›´æ¥æ•´åˆ Council Portal API
- ä¸€éµæäº¤åˆ° Council ç³»çµ±
- è‡ªå‹•è¿½è¹¤å›è¦†ç‹€æ…‹

**æŠ€è¡“æº–å‚™**:

```typescript
// æ¨¡çµ„åŒ–è¨­è¨ˆï¼Œç‚ºæœªä¾†æ•´åˆåšæº–å‚™
async function submitToCouncilPortal(
  coverLetterPDF: Buffer,
  council: CouncilType
) {
  switch (council) {
    case "auckland":
      // æœªä¾†ï¼šç›´æ¥ API ä¸Šå‚³
      return await aucklandPortalAPI.submit(coverLetterPDF);
    default:
      // ç•¶å‰ï¼šæä¾›ä¸‹è¼‰ + æ‰‹å‹•ä¸Šå‚³æŒ‡å¼•
      return {
        downloadUrl: generateURL(coverLetterPDF),
        portalUrl: getCouncilPortalURL(council),
        instructions: getUploadInstructions(council),
      };
  }
}
```

**è³‡æ–™åº«çµæ§‹**:

```typescript
// convex/schema.ts
rfis: defineTable({
  projectId: v.id("projects"),

  // åŸå§‹è¼¸å…¥
  originalFormat: v.string(), // 'email' | 'word' | 'pdf' | 'image'
  rawContent: v.string(),
  uploadedFiles: v.array(v.id("_storage")),

  // Processor è³‡è¨Š
  processorName: v.string(),
  processorEmail: v.optional(v.string()),
  council: v.string(),
  receivedDate: v.number(),

  // AI è§£æå¾Œçš„å•é¡Œ
  questions: v.array(
    v.object({
      id: v.string(),
      number: v.number(),
      originalText: v.string(), // ä¿ç•™åŸæ–‡ï¼ˆå«éŒ¯èª¤ï¼‰
      category: v.optional(v.string()), // AI åˆ†é¡
      isDuplicate: v.optional(v.boolean()),
      duplicateOf: v.optional(v.number()),
      attachedImages: v.optional(v.array(v.string())),
      attachedLinks: v.optional(v.array(v.string())),
    })
  ),

  // ç”¨æˆ¶å›ç­”
  responses: v.optional(
    v.array(
      v.object({
        questionId: v.string(),
        responseText: v.string(),
        responseImages: v.optional(v.array(v.id("_storage"))),
        respondedAt: v.number(),
        respondedBy: v.id("users"),
      })
    )
  ),

  // Cover Letter
  coverLetter: v.optional(
    v.object({
      pdfStorageId: v.id("_storage"),
      generatedAt: v.number(),
      downloadCount: v.number(),
    })
  ),

  // ç‹€æ…‹è¿½è¹¤
  status: v.string(), // 'pending' | 'in-progress' | 'completed' | 'submitted'
  submittedToCouncil: v.optional(v.boolean()),
  submittedAt: v.optional(v.number()),

  // é€šçŸ¥è¨˜éŒ„
  notificationsSent: v.optional(
    v.array(
      v.object({
        sentAt: v.number(),
        recipients: v.array(v.id("users")),
      })
    )
  ),
});
```

**å·¥ä½œæµç¨‹ç¸½è¦½**:

```
1. ç”¨æˆ¶ä¸Šå‚³ RFIï¼ˆå¤šç¨®æ ¼å¼ï¼‰
      â†“
2. AI è§£æä¸¦æ¸…ç†æ ¼å¼ï¼ˆä¿ç•™åŸæ–‡ï¼‰
      â†“
3. é¡¯ç¤ºçµæ§‹åŒ–ç·šä¸Šæ–‡æª”
      â†“
4. ç”¨æˆ¶å¡«å¯«å›ç­” + ä¸Šå‚³åœ–ç‰‡
      â†“
5. å³æ™‚ç”Ÿæˆ Cover Letter PDF é è¦½
      â†“
6. ä¸‹è¼‰ PDFï¼ˆç”¨æ–¼ Council Portal ä¸Šå‚³ï¼‰
      â†“
7. ç™¼é€é€šçŸ¥çµ¦åœ˜éšŠæˆå“¡ï¼ˆå¯é¸ï¼‰
      â†“
8. è¨˜éŒ„åˆ°å°ˆæ¡ˆæ­·å²
      â†“
9. æœªä¾†ï¼šç›´æ¥æäº¤åˆ° Council Portal
```

**æŠ€è¡“æ•´åˆ**:

- AI æ¨¡å‹: Google Gemini 2.0 Flash
- æ–‡æª”è™•ç†: mammoth.js, pdf-parse, LangChain
- OCR: Google Document AI
- PDF ç”Ÿæˆ: @react-pdf/renderer (Phase 1-3) / Nutrient Generation API (Phase 4+)
- PDF æª¢è¦–: React-PDF (Phase 1-3) / Nutrient SDK (Phase 4+)
- Rich Text Editor: Tiptap / Lexical
- Email: Resend / SendGrid
- é€šçŸ¥: Convex Real-time + Email

### 4. æ³•è¦çŸ¥è­˜åº«ç³»çµ± (Regulatory Knowledge Base)

**ç›®æ¨™**: å»ºç«‹å®Œæ•´çš„å»ºç¯‰æ³•è¦å’Œåˆè¦æ€§è³‡æ–™åº«ï¼Œä½¿ç”¨ Google AI æŠ€è¡“å¯¦ç¾é«˜æ•ˆæ™ºèƒ½å•ç­”

#### Google AI æ•´åˆæ–¹æ¡ˆ - RAG (Retrieval-Augmented Generation) æ¶æ§‹:

**æ ¸å¿ƒæŠ€è¡“æ£§**:

1. **Gemini Embeddings API** (`gemini-embedding-001`)
   - å°‡ PDF æ³•è¦æ–‡ä»¶è½‰æ›ç‚ºå‘é‡åµŒå…¥ (Vector Embeddings)
   - æ”¯æ´ç¶­åº¦: 768, 1536, 3072 (å»ºè­°ä½¿ç”¨ 768 ç¯€çœå„²å­˜ç©ºé–“)
   - ä»»å‹™é¡å‹: `RETRIEVAL_DOCUMENT` (ç´¢å¼•æ–‡ä»¶) + `QUESTION_ANSWERING` (æŸ¥è©¢)
   
2. **Gemini Document Processing API**
   - åŸç”Ÿç†è§£ PDF å…§å®¹ï¼ˆæ–‡å­—ã€åœ–è¡¨ã€è¡¨æ ¼ï¼‰
   - æ”¯æ´æœ€å¤š 1000 é  PDF æˆ– 50MB
   - æ¯é  = 258 tokens

3. **Context Caching**
   - **Implicit Caching** (è‡ªå‹•å•Ÿç”¨): Gemini 2.5 Flash æœ€ä½ 1024 tokens è‡ªå‹•å¿«å–
   - **Explicit Caching** (æ‰‹å‹•æ§åˆ¶): å¤§å‹æ³•è¦æ–‡ä»¶å¿«å–å¾Œé‡è¤‡ä½¿ç”¨ï¼Œå¤§å¹…é™ä½æˆæœ¬
   - TTL å¯è¨­å®š (é è¨­ 1 å°æ™‚ï¼Œå¯å»¶é•·)

4. **Vector Database** (å„²å­˜åµŒå…¥å‘é‡)
   - é¸é … 1: **Convex Database** (å…§å»ºå‘é‡æœå°‹ï¼ŒPhase 1-2)
   - é¸é … 2: **Google Cloud BigQuery** (ä¼æ¥­ç´šï¼ŒPhase 3+)
   - é¸é … 3: **Pinecone / Qdrant / Weaviate** (ç¬¬ä¸‰æ–¹å‘é‡è³‡æ–™åº«)

#### è³‡æ–™è™•ç†æµç¨‹:

**A. å»ºç«‹çŸ¥è­˜åº« (ä¸€æ¬¡æ€§è™•ç†)**

```typescript
// lib/knowledge-base/build-index.ts
import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);

interface RegulationDocument {
  id: string;
  title: string;
  source: 'NZ Building Code' | 'BRANZ' | 'Council' | 'Supplier';
  category: 'Structural' | 'Fire Safety' | 'Insulation' | 'Plumbing' | 'Other';
  pdfUrl: string;
  uploadDate: Date;
}

// Step 1: è™•ç† PDF ä¸¦æå–å…§å®¹
async function processRegulationPDF(doc: RegulationDocument) {
  // 1.1 ä¸Šå‚³ PDF åˆ° Gemini Files API (å¯é‡è¤‡ä½¿ç”¨ 48 å°æ™‚)
  const uploadedFile = await genAI.uploadFile(doc.pdfUrl, {
    mimeType: 'application/pdf',
  });

  // 1.2 ä½¿ç”¨ Gemini æå–çµæ§‹åŒ–å…§å®¹
  const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
  
  const extractionPrompt = `
    Extract structured information from this building regulation document:
    1. Document title and reference number
    2. Key sections and their page numbers
    3. Technical requirements (dimensions, materials, standards)
    4. Compliance criteria
    5. Related standards or references
    
    Output as JSON.
  `;

  const result = await model.generateContent([uploadedFile, extractionPrompt]);
  const structuredData = JSON.parse(result.response.text());

  return { uploadedFile, structuredData };
}

// Step 2: ç”Ÿæˆ Embeddingsï¼ˆåˆ†æ®µè™•ç†ï¼‰
async function generateEmbeddings(document: any) {
  const embeddingModel = genAI.getGenerativeModel({ 
    model: "gemini-embedding-001" 
  });

  // å°‡æ–‡ä»¶åˆ†æˆå°æ®µï¼ˆæ¯æ®µ < 2048 tokensï¼‰
  const chunks = splitIntoChunks(document.structuredData, 1500);

  const embeddings = [];
  
  for (const chunk of chunks) {
    const result = await embeddingModel.embedContent({
      content: chunk.text,
      taskType: "RETRIEVAL_DOCUMENT",
      outputDimensionality: 768, // ç¯€çœå„²å­˜ç©ºé–“
    });

    embeddings.push({
      chunkId: chunk.id,
      documentId: document.id,
      text: chunk.text,
      embedding: result.embedding.values,
      metadata: {
        source: document.source,
        category: document.category,
        pageNumber: chunk.pageNumber,
      }
    });
  }

  return embeddings;
}

// Step 3: å„²å­˜åˆ°å‘é‡è³‡æ–™åº«
async function storeEmbeddings(embeddings: any[]) {
  // é¸é … 1: Convex (Phase 1-2)
  await Promise.all(
    embeddings.map(emb => 
      convex.mutation.knowledgeBase.insertEmbedding({
        ...emb,
        embedding: Array.from(emb.embedding), // è½‰ç‚ºé™£åˆ—
      })
    )
  );

  // é¸é … 2: Pinecone (Phase 3+)
  // await pineconeIndex.upsert(embeddings);
}

// å®Œæ•´æµç¨‹
async function buildKnowledgeBase(documents: RegulationDocument[]) {
  for (const doc of documents) {
    console.log(`Processing: ${doc.title}`);
    
    // 1. æå–å…§å®¹
    const processed = await processRegulationPDF(doc);
    
    // 2. ç”ŸæˆåµŒå…¥
    const embeddings = await generateEmbeddings({
      id: doc.id,
      ...processed,
      source: doc.source,
      category: doc.category,
    });
    
    // 3. å„²å­˜
    await storeEmbeddings(embeddings);
    
    console.log(`âœ“ Indexed ${embeddings.length} chunks from ${doc.title}`);
  }
}
```

**B. ç”¨æˆ¶æŸ¥è©¢æµç¨‹ (å¯¦æ™‚å•ç­”)**

```typescript
// lib/knowledge-base/query.ts

interface QueryResult {
  answer: string;
  sources: {
    documentTitle: string;
    pageNumber: number;
    relevanceScore: number;
    excerpt: string;
  }[];
  cachedTokens?: number;
}

async function answerRegulationQuery(
  userQuestion: string
): Promise<QueryResult> {
  
  // Step 1: å°‡å•é¡Œè½‰æ›ç‚ºåµŒå…¥å‘é‡
  const embeddingModel = genAI.getGenerativeModel({ 
    model: "gemini-embedding-001" 
  });
  
  const questionEmbedding = await embeddingModel.embedContent({
    content: userQuestion,
    taskType: "QUESTION_ANSWERING", // å„ªåŒ–æŸ¥è©¢ç”¨é€”
    outputDimensionality: 768,
  });

  // Step 2: å‘é‡ç›¸ä¼¼åº¦æœå°‹ (æ‰¾æœ€ç›¸é—œçš„ 5 æ®µå…§å®¹)
  const relevantChunks = await convex.query.knowledgeBase.searchSimilar({
    embedding: Array.from(questionEmbedding.embedding.values),
    limit: 5,
    threshold: 0.7, // ç›¸ä¼¼åº¦é–¾å€¼
  });

  // Step 3: ä½¿ç”¨ Context Caching å„ªåŒ–æˆæœ¬
  const cachedContext = relevantChunks
    .map(chunk => `[${chunk.metadata.source} - Page ${chunk.metadata.pageNumber}]\n${chunk.text}`)
    .join('\n\n---\n\n');

  // å»ºç«‹æˆ–ç²å–å¿«å–
  let cache = await genAI.caches.get({ name: "regulation-context-cache" });
  
  if (!cache) {
    cache = await genAI.caches.create({
      model: "gemini-2.5-flash",
      contents: [{
        role: "user",
        parts: [{
          text: `You are a building regulation expert. Use the following regulation excerpts to answer questions:\n\n${cachedContext}`
        }]
      }],
      ttl: 3600, // å¿«å– 1 å°æ™‚
    });
  }

  // Step 4: ç”Ÿæˆç­”æ¡ˆ (ä½¿ç”¨å¿«å–çš„æ³•è¦å…§å®¹)
  const model = genAI.getGenerativeModel({ 
    model: "gemini-2.5-flash",
    cachedContent: cache.name,
  });

  const response = await model.generateContent(userQuestion);

  // Step 5: è¿”å›ç­”æ¡ˆå’Œä¾†æº
  return {
    answer: response.response.text(),
    sources: relevantChunks.map(chunk => ({
      documentTitle: chunk.documentTitle,
      pageNumber: chunk.metadata.pageNumber,
      relevanceScore: chunk.similarity,
      excerpt: chunk.text.substring(0, 200) + '...',
    })),
    cachedTokens: response.usageMetadata?.cachedContentTokenCount,
  };
}
```

**C. Convex Schema å®šç¾©**

```typescript
// convex/schema.ts

import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  // æ³•è¦æ–‡ä»¶
  regulationDocuments: defineTable({
    title: v.string(),
    source: v.string(), // 'NZ Building Code', 'BRANZ', etc.
    category: v.string(),
    pdfStorageId: v.id("_storage"),
    geminiFileId: v.optional(v.string()), // Files API ID
    uploadedAt: v.number(),
    processedAt: v.optional(v.number()),
    totalPages: v.number(),
    totalChunks: v.number(),
  }).index("by_source", ["source"])
    .index("by_category", ["category"]),

  // å‘é‡åµŒå…¥ï¼ˆåˆ†æ®µï¼‰
  regulationEmbeddings: defineTable({
    documentId: v.id("regulationDocuments"),
    chunkIndex: v.number(),
    text: v.string(),
    embedding: v.array(v.float64()), // 768 ç¶­å‘é‡
    metadata: v.object({
      source: v.string(),
      category: v.string(),
      pageNumber: v.number(),
      sectionTitle: v.optional(v.string()),
    }),
  }).index("by_document", ["documentId"])
    .vectorIndex("by_embedding", {
      vectorField: "embedding",
      dimensions: 768,
      filterFields: ["metadata.source", "metadata.category"],
    }),

  // ç”¨æˆ¶æŸ¥è©¢æ­·å²
  regulationQueries: defineTable({
    userId: v.id("users"),
    question: v.string(),
    answer: v.string(),
    sources: v.array(v.object({
      documentId: v.id("regulationDocuments"),
      pageNumber: v.number(),
      relevanceScore: v.float64(),
    })),
    cachedTokensUsed: v.optional(v.number()),
    queriedAt: v.number(),
  }).index("by_user", ["userId"]),
});
```

#### å…§å®¹ä¾†æºç®¡ç†:

**å®˜æ–¹æ³•è¦åº«**
- NZ Building Code (MBIE)
- Building Consent Authority (BCA) - Australia
- BRANZ Technical Recommendations
- Council District Plans (Auckland, Wellington, Christchurch)
- Environmental & Safety Standards (EPA, WorkSafe)

**ä¾›æ‡‰å•†åˆè¦è³‡æ–™**
- ç”¢å“æŠ€è¡“è¦æ ¼ (Appraisals, CodeMark)
- å®‰è£æ–½å·¥æ¨™æº– (Installation Guides)
- èªè­‰å’Œæ¸¬è©¦å ±å‘Š (ISO, AS/NZS)
- ç¶­è­·ä¿é¤ŠæŒ‡å— (Warranty Documents)

**ç”¨æˆ¶è²¢ç»å…§å®¹**
- ç”¨æˆ¶ä¸Šå‚³çš„å¸¸ç”¨æ³•è¦ (éœ€å¯©æ ¸)
- å¯¦å‹™ç¶“é©—åˆ†äº« (Case Studies)
- å•é¡Œè§£æ±ºæ–¹æ¡ˆ (Best Practices)

#### æˆæœ¬å„ªåŒ–ç­–ç•¥:

**1. Batch Embeddings (æ‰¹æ¬¡è™•ç†)**
```typescript
// ä½¿ç”¨ Batch API ç”ŸæˆåµŒå…¥ï¼Œæˆæœ¬é™ä½ 50%
const batchResults = await genAI.batchEmbedContent({
  requests: documents.map(doc => ({
    model: "gemini-embedding-001",
    content: doc.text,
    taskType: "RETRIEVAL_DOCUMENT",
  }))
});
```

**2. Context Caching (æ¸›å°‘é‡è¤‡æˆæœ¬)**
- å¸¸ç”¨æ³•è¦æ–‡ä»¶å¿«å– 1 å°æ™‚æˆ–æ›´é•·
- å¿«å–å‘½ä¸­å¯ç¯€çœ 75% æˆæœ¬
- Implicit Caching è‡ªå‹•å•Ÿç”¨ (Gemini 2.5 Flash)

**3. Embedding ç¶­åº¦å„ªåŒ–**
- ä½¿ç”¨ 768 ç¶­è€Œé 3072 ç¶­
- ç¯€çœ 75% å„²å­˜ç©ºé–“
- MTEB åˆ†æ•¸åƒ…é™ä½ 0.17 (67.99 vs 68.16)

**æˆæœ¬ä¼°ç®—** (æ¯æœˆ):
```
å‡è¨­: 500 ä»½æ³•è¦æ–‡ä»¶ï¼Œå¹³å‡ 50 é /ä»½
- ç¸½é æ•¸: 25,000 é 
- Embeddings ç”Ÿæˆ (ä¸€æ¬¡æ€§): 25,000 Ã— 258 tokens Ã— $0.0001 = $0.65
- å‘é‡å„²å­˜: 25,000 chunks Ã— 768 dims Ã— 4 bytes = 77MB â†’ Convex å…è²»
- ç”¨æˆ¶æŸ¥è©¢ (1000 æ¬¡/æœˆ):
  * å•é¡ŒåµŒå…¥: 1000 Ã— 50 tokens Ã— $0.0001 = $0.005
  * Gemini ç”Ÿæˆ (ä½¿ç”¨ Context Caching):
    - Cached input: 1000 Ã— 5000 tokens Ã— $0.000025 = $0.125
    - Output: 1000 Ã— 500 tokens Ã— $0.0003 = $0.15
  
ç¸½æˆæœ¬: ~$0.93/æœˆ (vs ç„¡å¿«å– ~$3.5/æœˆï¼Œç¯€çœ 73%)
```

#### ç”¨æˆ¶ä»‹é¢ç¯„ä¾‹:

```tsx
// components/RegulationSearch.tsx
<RegulationSearchInterface>
  <SearchBar 
    placeholder="Ask about NZ Building Code, BRANZ standards, or Council requirements..."
    onSubmit={handleQuery}
  />
  
  {loading && <Skeleton />}
  
  {result && (
    <>
      <AnswerCard>
        <AIResponse>{result.answer}</AIResponse>
        {result.cachedTokens && (
          <CostSaving>
            ğŸ’š Saved {result.cachedTokens} tokens using cached context
          </CostSaving>
        )}
      </AnswerCard>
      
      <SourcesList>
        <h3>Sources:</h3>
        {result.sources.map(source => (
          <SourceCard 
            key={source.documentTitle}
            title={source.documentTitle}
            page={source.pageNumber}
            relevance={source.relevanceScore}
            excerpt={source.excerpt}
            onViewPDF={() => openPDF(source.documentId)}
          />
        ))}
      </SourcesList>
    </>
  )}
</RegulationSearchInterface>
```

#### PDF å„²å­˜ç­–ç•¥:

**é¸é … 1: Convex File Storage (æ¨è–¦ Phase 1-2)**

```typescript
// ç®¡ç†å“¡ä¸Šå‚³æ³•è¦ PDF
// app/admin/regulations/upload/page.tsx

async function uploadRegulationPDF(file: File) {
  // 1. ä¸Šå‚³åˆ° Convex Storage
  const storageId = await convex.mutation.regulations.uploadPDF({
    file: file,
    metadata: {
      title: "NZ Building Code - Clause B1 Structure",
      source: "MBIE",
      category: "Structural",
      version: "2024",
    }
  });

  // 2. è§¸ç™¼èƒŒæ™¯è™•ç†ï¼ˆConvex Actionï¼‰
  await convex.action.regulations.processDocument({
    storageId: storageId,
  });

  return storageId;
}

// convex/regulations.ts
export const uploadPDF = mutation({
  args: {
    file: v.any(),
    metadata: v.object({
      title: v.string(),
      source: v.string(),
      category: v.string(),
      version: v.string(),
    }),
  },
  handler: async (ctx, args) => {
    // å„²å­˜åˆ° Convex Storage
    const storageId = await ctx.storage.store(args.file);
    
    // è¨˜éŒ„åˆ°è³‡æ–™åº«
    const docId = await ctx.db.insert("regulationDocuments", {
      ...args.metadata,
      pdfStorageId: storageId,
      uploadedAt: Date.now(),
      status: "pending_processing",
    });

    return storageId;
  },
});
```

**é¸é … 2: AWS S3 + Gemini Files API (Phase 3+)**

```typescript
// å¤§é‡æ³•è¦æ–‡ä»¶å­˜åœ¨ S3ï¼Œæˆæœ¬æ›´ä½
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";

async function uploadToS3AndProcess(file: File) {
  const s3 = new S3Client({ region: "ap-southeast-2" });
  
  // 1. ä¸Šå‚³åˆ° S3
  await s3.send(new PutObjectCommand({
    Bucket: "archidocky-regulations",
    Key: `regulations/${file.name}`,
    Body: file,
    ContentType: "application/pdf",
  }));

  const s3Url = `https://archidocky-regulations.s3.ap-southeast-2.amazonaws.com/regulations/${file.name}`;

  // 2. è¨˜éŒ„åˆ° Convexï¼ˆåªå­˜ URLï¼Œä¸å­˜æª”æ¡ˆï¼‰
  await convex.mutation.regulations.create({
    title: file.name,
    s3Url: s3Url,
    status: "pending_processing",
  });

  return s3Url;
}
```

**å„²å­˜æˆæœ¬æ¯”è¼ƒ**:
```
å‡è¨­ 500 ä»½æ³•è¦ PDFï¼Œå¹³å‡ 5MB/ä»½ = 2.5GB

Convex Storage:
- 5GB å…è²»é¡åº¦ â†’ å‰ 2.5GB å…è²»
- è¶…å‡ºéƒ¨åˆ†: $0.25/GB â†’ $0

AWS S3 Standard:
- å„²å­˜: 2.5GB Ã— $0.023/GB = $0.058/æœˆ
- è«‹æ±‚è²»ç”¨: 500 æ¬¡ä¸Šå‚³ Ã— $0.005/1000 = $0.0025

çµè«–: Phase 1-2 ç”¨ Convex (å…è²»)ï¼ŒPhase 3+ å¦‚è¶…é 5GB æ‰è€ƒæ…® S3
```

#### é¤µçµ¦ AI çš„å®Œæ•´æµç¨‹:

**æ–¹æ³• 1: Gemini Files API (æ¨è–¦ï¼Œ48å°æ™‚å…è²»å¿«å–)**

```typescript
// convex/actions.ts (Server-side Action)
import { v } from "convex/values";
import { action } from "./_generated/server";
import { GoogleGenerativeAI } from "@google/generative-ai";

export const processDocument = action({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, args) => {
    // 1. å¾ Convex Storage å–å¾— PDF URL
    const pdfUrl = await ctx.storage.getUrl(args.storageId);
    
    if (!pdfUrl) throw new Error("PDF not found");

    // 2. ä¸‹è¼‰ PDF ç‚º Buffer
    const response = await fetch(pdfUrl);
    const pdfBuffer = await response.arrayBuffer();

    // 3. ä¸Šå‚³åˆ° Gemini Files API (48 å°æ™‚å…è²»å„²å­˜)
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
    
    const uploadedFile = await genAI.files.upload({
      file: {
        data: Buffer.from(pdfBuffer),
        mimeType: "application/pdf",
      },
      displayName: "Building Regulation Document",
    });

    console.log(`âœ“ Uploaded to Gemini: ${uploadedFile.uri}`);

    // 4. è®“ Gemini æå–çµæ§‹åŒ–å…§å®¹
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
    
    const extractionPrompt = `
      Analyze this building regulation PDF and extract:
      
      1. Document Metadata:
         - Official title and reference number
         - Publication date and version
         - Issuing authority (MBIE, Council, BRANZ, etc.)
      
      2. Table of Contents:
         - All section titles and page numbers
         - Hierarchical structure (chapters, sections, subsections)
      
      3. Technical Requirements:
         - Specific dimensions, measurements, tolerances
         - Material specifications
         - Referenced standards (NZS, AS/NZS, ISO)
         - Compliance criteria and acceptance methods
      
      4. Key Concepts:
         - Important definitions and terms
         - Performance requirements
         - Limitations and exclusions
      
      Output as structured JSON with this schema:
      {
        "metadata": {...},
        "tableOfContents": [...],
        "sections": [
          {
            "title": "string",
            "pageNumber": number,
            "content": "string",
            "requirements": [...],
            "references": [...]
          }
        ],
        "glossary": {...}
      }
    `;

    const result = await model.generateContent([
      {
        fileData: {
          mimeType: uploadedFile.mimeType,
          fileUri: uploadedFile.uri,
        },
      },
      { text: extractionPrompt },
    ]);

    const extractedData = JSON.parse(result.response.text());

    // 5. å„²å­˜æå–çš„çµæ§‹åŒ–æ•¸æ“š
    await ctx.runMutation(api.regulations.saveExtractedData, {
      storageId: args.storageId,
      geminiFileUri: uploadedFile.uri,
      extractedData: extractedData,
    });

    // 6. ç”Ÿæˆ Embeddingsï¼ˆåˆ†æ®µè™•ç†ï¼‰
    await ctx.runAction(api.regulations.generateEmbeddings, {
      storageId: args.storageId,
      sections: extractedData.sections,
    });

    return { success: true, geminiFileUri: uploadedFile.uri };
  },
});

// ç”Ÿæˆ Embeddings
export const generateEmbeddings = action({
  args: {
    storageId: v.id("_storage"),
    sections: v.any(),
  },
  handler: async (ctx, args) => {
    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
    const embeddingModel = genAI.getGenerativeModel({ 
      model: "gemini-embedding-001" 
    });

    // å°‡æ¯å€‹ section åˆ†æˆå°å¡Šï¼ˆé¿å…è¶…é 2048 token é™åˆ¶ï¼‰
    const chunks = [];
    for (const section of args.sections) {
      const sectionChunks = splitTextIntoChunks(section.content, 1500);
      
      sectionChunks.forEach((chunk, index) => {
        chunks.push({
          text: chunk,
          metadata: {
            sectionTitle: section.title,
            pageNumber: section.pageNumber,
            chunkIndex: index,
          },
        });
      });
    }

    // æ‰¹æ¬¡ç”Ÿæˆ embeddings (Batch API ç¯€çœ 50% æˆæœ¬)
    const batchSize = 100;
    for (let i = 0; i < chunks.length; i += batchSize) {
      const batch = chunks.slice(i, i + batchSize);
      
      const embeddings = await Promise.all(
        batch.map(async (chunk) => {
          const result = await embeddingModel.embedContent({
            content: chunk.text,
            taskType: "RETRIEVAL_DOCUMENT",
            outputDimensionality: 768,
          });

          return {
            text: chunk.text,
            embedding: Array.from(result.embedding.values),
            metadata: chunk.metadata,
          };
        })
      );

      // å„²å­˜åˆ° Convex
      await ctx.runMutation(api.regulations.insertEmbeddings, {
        storageId: args.storageId,
        embeddings: embeddings,
      });

      console.log(`âœ“ Processed ${i + batch.length}/${chunks.length} chunks`);
    }

    return { totalChunks: chunks.length };
  },
});

// è¼”åŠ©å‡½æ•¸ï¼šåˆ†æ®µ
function splitTextIntoChunks(text: string, maxTokens: number): string[] {
  // ç°¡å–®åˆ†æ®µé‚è¼¯ï¼ˆå¯¦éš›æ‡‰ä½¿ç”¨ tokenizerï¼‰
  const words = text.split(/\s+/);
  const chunks: string[] = [];
  let currentChunk: string[] = [];
  let currentTokens = 0;

  for (const word of words) {
    const wordTokens = Math.ceil(word.length / 4); // ç²—ç•¥ä¼°è¨ˆ
    
    if (currentTokens + wordTokens > maxTokens) {
      chunks.push(currentChunk.join(" "));
      currentChunk = [word];
      currentTokens = wordTokens;
    } else {
      currentChunk.push(word);
      currentTokens += wordTokens;
    }
  }

  if (currentChunk.length > 0) {
    chunks.push(currentChunk.join(" "));
  }

  return chunks;
}
```

**æ–¹æ³• 2: ç›´æ¥è™•ç†ï¼ˆå°å‹ PDF < 10MBï¼‰**

```typescript
// å¦‚æœ PDF è¼ƒå°ï¼Œå¯ä»¥ç›´æ¥åœ¨è«‹æ±‚ä¸­å‚³é€
export const processSmallPDF = action({
  args: { storageId: v.id("_storage") },
  handler: async (ctx, args) => {
    const pdfUrl = await ctx.storage.getUrl(args.storageId);
    const response = await fetch(pdfUrl);
    const pdfBuffer = await response.arrayBuffer();

    const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

    // ç›´æ¥å‚³é€ base64 ç·¨ç¢¼çš„ PDF
    const base64Pdf = Buffer.from(pdfBuffer).toString('base64');
    
    const result = await model.generateContent([
      {
        inlineData: {
          mimeType: "application/pdf",
          data: base64Pdf,
        },
      },
      { text: "Summarize this document" },
    ]);

    return result.response.text();
  },
});
```

#### é©—è­‰ AI æ˜¯å¦çœŸæ­£ç†è§£å…§å®¹:

**æ¸¬è©¦ç­–ç•¥ 1: å•ç­”é©—è­‰ (Q&A Testing)**

```typescript
// tests/knowledge-base-validation.test.ts

interface ValidationQuestion {
  question: string;
  expectedAnswer: string;
  documentTitle: string;
  pageNumber: number;
  category: 'factual' | 'comprehension' | 'application';
}

const validationQuestions: ValidationQuestion[] = [
  // äº‹å¯¦å‹å•é¡Œï¼ˆç›´æ¥å¾æ–‡ä»¶æå–ï¼‰
  {
    question: "What is the minimum concrete strength for foundations in NZ Building Code B1?",
    expectedAnswer: "17.5 MPa",
    documentTitle: "NZ Building Code - Clause B1",
    pageNumber: 23,
    category: "factual",
  },
  
  // ç†è§£å‹å•é¡Œï¼ˆéœ€è¦ç¶œåˆç†è§£ï¼‰
  {
    question: "When is a building consent required for deck construction in Auckland?",
    expectedAnswer: "When the deck is higher than 1.5m above ground or attached to a dwelling",
    documentTitle: "Auckland Building Consent Requirements",
    pageNumber: 12,
    category: "comprehension",
  },
  
  // æ‡‰ç”¨å‹å•é¡Œï¼ˆéœ€è¦æ¨ç†ï¼‰
  {
    question: "Can I use H1.2 treated timber for external cladding in Wellington's coastal area?",
    expectedAnswer: "No, coastal areas require H3.2 treatment minimum due to high corrosion risk",
    documentTitle: "BRANZ Timber Treatment Standards",
    pageNumber: 45,
    category: "application",
  },
];

async function runValidationTests() {
  const results = [];
  
  for (const test of validationQuestions) {
    console.log(`\nTesting: ${test.question}`);
    
    // æŸ¥è©¢ AI
    const aiResponse = await answerRegulationQuery(test.question);
    
    // é©—è­‰ç­”æ¡ˆç›¸ä¼¼åº¦
    const similarity = calculateSemanticSimilarity(
      aiResponse.answer,
      test.expectedAnswer
    );
    
    // é©—è­‰ä¾†æºæ­£ç¢ºæ€§
    const correctSource = aiResponse.sources.some(
      s => s.documentTitle === test.documentTitle &&
           Math.abs(s.pageNumber - test.pageNumber) <= 2 // å…è¨± Â±2 é èª¤å·®
    );
    
    const passed = similarity > 0.8 && correctSource;
    
    results.push({
      question: test.question,
      category: test.category,
      aiAnswer: aiResponse.answer,
      expectedAnswer: test.expectedAnswer,
      similarity: similarity,
      correctSource: correctSource,
      passed: passed,
    });
    
    console.log(`  âœ“ Similarity: ${(similarity * 100).toFixed(1)}%`);
    console.log(`  âœ“ Source: ${correctSource ? 'Correct' : 'Wrong'}`);
    console.log(`  ${passed ? 'âœ… PASSED' : 'âŒ FAILED'}`);
  }
  
  // ç”Ÿæˆå ±å‘Š
  const passRate = results.filter(r => r.passed).length / results.length;
  console.log(`\nğŸ“Š Overall Pass Rate: ${(passRate * 100).toFixed(1)}%`);
  
  return results;
}

// èªç¾©ç›¸ä¼¼åº¦è¨ˆç®—
async function calculateSemanticSimilarity(text1: string, text2: string): Promise<number> {
  const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY!);
  const embeddingModel = genAI.getGenerativeModel({ model: "gemini-embedding-001" });
  
  const [emb1, emb2] = await Promise.all([
    embeddingModel.embedContent({ content: text1, taskType: "SEMANTIC_SIMILARITY" }),
    embeddingModel.embedContent({ content: text2, taskType: "SEMANTIC_SIMILARITY" }),
  ]);
  
  // é¤˜å¼¦ç›¸ä¼¼åº¦
  return cosineSimilarity(emb1.embedding.values, emb2.embedding.values);
}

function cosineSimilarity(a: number[], b: number[]): number {
  const dotProduct = a.reduce((sum, val, i) => sum + val * b[i], 0);
  const magA = Math.sqrt(a.reduce((sum, val) => sum + val * val, 0));
  const magB = Math.sqrt(b.reduce((sum, val) => sum + val * val, 0));
  return dotProduct / (magA * magB);
}
```

**æ¸¬è©¦ç­–ç•¥ 2: ä¾†æºè¿½è¹¤é©—è­‰ (Source Tracing)**

```typescript
// é©—è­‰ AI å›ç­”çš„ä¾†æºæ˜¯å¦çœŸå¯¦å­˜åœ¨
async function verifySourceAccuracy(question: string) {
  const response = await answerRegulationQuery(question);
  
  for (const source of response.sources) {
    // 1. å–å¾—åŸå§‹ PDF
    const pdfUrl = await convex.query.regulations.getPDFUrl({
      documentId: source.documentId,
    });
    
    // 2. æå–ç‰¹å®šé é¢å…§å®¹
    const pageContent = await extractPDFPage(pdfUrl, source.pageNumber);
    
    // 3. æª¢æŸ¥å¼•ç”¨çš„å…§å®¹æ˜¯å¦çœŸå¯¦å­˜åœ¨
    const excerptExists = pageContent.includes(source.excerpt.substring(0, 50));
    
    console.log(`Source: ${source.documentTitle} - Page ${source.pageNumber}`);
    console.log(`Excerpt exists: ${excerptExists ? 'âœ…' : 'âŒ'}`);
    
    if (!excerptExists) {
      console.warn(`âš ï¸ Hallucination detected! Source may be incorrect.`);
    }
  }
}
```

**æ¸¬è©¦ç­–ç•¥ 3: å°æ¯”æ¸¬è©¦ (A/B Testing)**

```typescript
// åŒä¸€å•é¡Œå•å…©æ¬¡ï¼Œæª¢æŸ¥ç­”æ¡ˆä¸€è‡´æ€§
async function testConsistency(question: string, runs: number = 5) {
  const answers = [];
  
  for (let i = 0; i < runs; i++) {
    const response = await answerRegulationQuery(question);
    answers.push(response.answer);
  }
  
  // è¨ˆç®—ç­”æ¡ˆä¹‹é–“çš„ç›¸ä¼¼åº¦
  const similarities = [];
  for (let i = 0; i < answers.length - 1; i++) {
    const sim = await calculateSemanticSimilarity(answers[i], answers[i + 1]);
    similarities.push(sim);
  }
  
  const avgSimilarity = similarities.reduce((a, b) => a + b, 0) / similarities.length;
  
  console.log(`Consistency Score: ${(avgSimilarity * 100).toFixed(1)}%`);
  
  if (avgSimilarity < 0.85) {
    console.warn('âš ï¸ Low consistency - AI may be hallucinating');
  }
  
  return { avgSimilarity, answers };
}
```

**æ¸¬è©¦ç­–ç•¥ 4: äººå·¥å¯©æ ¸ç•Œé¢ (Human Review UI)**

```tsx
// components/admin/KnowledgeBaseReview.tsx
<ReviewInterface>
  {testResults.map(result => (
    <ReviewCard key={result.question}>
      <Question>{result.question}</Question>
      
      <ComparisonView>
        <Column>
          <Label>Expected Answer</Label>
          <Text>{result.expectedAnswer}</Text>
        </Column>
        
        <Column>
          <Label>AI Answer</Label>
          <Text>{result.aiAnswer}</Text>
        </Column>
      </ComparisonView>
      
      <Metrics>
        <Metric>
          <Label>Semantic Similarity</Label>
          <Progress value={result.similarity * 100} />
          <Value>{(result.similarity * 100).toFixed(1)}%</Value>
        </Metric>
        
        <Metric>
          <Label>Source Accuracy</Label>
          <Badge variant={result.correctSource ? 'success' : 'error'}>
            {result.correctSource ? 'Correct' : 'Wrong'}
          </Badge>
        </Metric>
      </Metrics>
      
      <Sources>
        {result.sources.map(source => (
          <SourceTag 
            key={source.documentTitle}
            onClick={() => openPDF(source.documentId, source.pageNumber)}
          >
            ğŸ“„ {source.documentTitle} - p.{source.pageNumber}
          </SourceTag>
        ))}
      </Sources>
      
      <Actions>
        <Button 
          variant={result.passed ? 'success' : 'destructive'}
          onClick={() => markReview(result.id, !result.passed)}
        >
          {result.passed ? 'âœ… Approve' : 'âŒ Needs Review'}
        </Button>
      </Actions>
    </ReviewCard>
  ))}
</ReviewInterface>
```

**è‡ªå‹•åŒ–é©—è­‰ç®¡é“ (CI/CD Integration)**

```yaml
# .github/workflows/validate-knowledge-base.yml
name: Validate Knowledge Base

on:
  schedule:
    - cron: '0 0 * * 0'  # æ¯é€±æ—¥åŸ·è¡Œ
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Run validation tests
        run: npm run test:knowledge-base
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CONVEX_DEPLOYMENT: ${{ secrets.CONVEX_DEPLOYMENT }}
      
      - name: Generate report
        run: npm run test:report
      
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: validation-report
          path: ./test-results/
      
      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âš ï¸ Knowledge Base validation failed!"
            }
```

#### æŒçºŒç›£æ§èˆ‡æ”¹é€²:

```typescript
// convex/analytics.ts

// è¨˜éŒ„æ¯æ¬¡æŸ¥è©¢çš„è³ªé‡æŒ‡æ¨™
export const logQueryQuality = mutation({
  args: {
    question: v.string(),
    answer: v.string(),
    sources: v.array(v.any()),
    userFeedback: v.optional(v.object({
      helpful: v.boolean(),
      accurate: v.boolean(),
      comment: v.optional(v.string()),
    })),
  },
  handler: async (ctx, args) => {
    await ctx.db.insert("queryLogs", {
      ...args,
      timestamp: Date.now(),
    });
  },
});

// åˆ†æä½è³ªé‡ç­”æ¡ˆ
export const analyzeLowQualityAnswers = query({
  handler: async (ctx) => {
    const lowQualityQueries = await ctx.db
      .query("queryLogs")
      .filter(q => 
        q.eq(q.field("userFeedback.helpful"), false) ||
        q.eq(q.field("userFeedback.accurate"), false)
      )
      .collect();

    // æ‰¾å‡ºéœ€è¦æ”¹é€²çš„æ–‡ä»¶
    const problematicDocs = {};
    lowQualityQueries.forEach(query => {
      query.sources.forEach(source => {
        if (!problematicDocs[source.documentId]) {
          problematicDocs[source.documentId] = 0;
        }
        problematicDocs[source.documentId]++;
      });
    });

    return { 
      totalLowQuality: lowQualityQueries.length,
      problematicDocs: problematicDocs,
    };
  },
});
```

#### æŠ€è¡“å„ªå‹¢:

âœ… **æº–ç¢ºæ€§é«˜** - Gemini åŸç”Ÿç†è§£ PDFï¼ˆå«åœ–è¡¨ã€è¡¨æ ¼ï¼‰  
âœ… **æˆæœ¬ä½** - Context Caching + Batch API ç¯€çœ 50-75% è²»ç”¨  
âœ… **å¯æ“´å±•** - æ”¯æ´ 1000 é æ–‡ä»¶ï¼Œå‘é‡è³‡æ–™åº«å¯ç„¡é™æ“´å±•  
âœ… **å³æ™‚æ›´æ–°** - æ–°æ³•è¦ä¸Šå‚³å¾Œè‡ªå‹•ç´¢å¼•  
âœ… **å¯è¿½æº¯** - æ¯å€‹ç­”æ¡ˆéƒ½é™„ä¾†æºå’Œé ç¢¼  
âœ… **å¤šèªè¨€** - æ”¯æ´ä¸­è‹±æ–‡æŸ¥è©¢ï¼ˆGemini å¤šèªè¨€èƒ½åŠ›ï¼‰  
âœ… **å¯é©—è­‰** - å®Œæ•´æ¸¬è©¦æ¡†æ¶ç¢ºä¿ç­”æ¡ˆå“è³ª  
âœ… **è‡ªæˆ‘æ”¹é€²** - ç”¨æˆ¶åé¥‹å¾ªç’°æŒçºŒå„ªåŒ–

### 5. RFI ç¤¾ç¾¤è«–å£‡ (RFI Community Forum)

**ç›®æ¨™**: å»ºç«‹ RFI å•é¡Œåˆ†äº«å’Œè§£æ±ºç¤¾ç¾¤

#### è«–å£‡åŠŸèƒ½:

**å•é¡Œåˆ†äº«**

- RFI æ¡ˆä¾‹åŒ¿åç™¼ä½ˆ
- å•é¡Œåˆ†é¡å’Œæ¨™ç±¤
- åœ–ç‰‡å’Œæ–‡æª”é™„ä»¶
- ç·Šæ€¥ç¨‹åº¦æ¨™è¨˜

**ç¤¾ç¾¤äº’å‹•**

- å°ˆå®¶å›ç­”å’Œå»ºè­°
- æŠ•ç¥¨å’Œè©•åˆ†ç³»çµ±
- æœ€ä½³ç­”æ¡ˆèªè­‰
- ç¶“é©—åˆ†äº«å’Œè¨è«–

**çŸ¥è­˜ç´¯ç©**

- å¸¸è¦‹å•é¡Œè³‡æ–™åº«
- è§£æ±ºæ–¹æ¡ˆæ¨¡æ¿åº«
- å°ˆå®¶è²¢ç»æ’è¡Œ
- æœå°‹å’Œæ¨è–¦ç³»çµ±

**æŠ€è¡“å¯¦ç¾**:

- è«–å£‡ç³»çµ±: è‡ªè¨‚é–‹ç™¼
- å…§å®¹ç®¡ç†: Convex
- æœå°‹åŠŸèƒ½: å…¨æ–‡æœå°‹
- é€šçŸ¥ç³»çµ±: å³æ™‚æ¨æ’­

## æŠ€è¡“æ¶æ§‹è¨­è¨ˆ

### å‰ç«¯æŠ€è¡“æ£§

- **æ¡†æ¶**: Next.js 16 (App Router)
- **ç‹€æ…‹ç®¡ç†**: Convex (è‡ªå¸¶ç‹€æ…‹ç®¡ç†)
- **æ¨£å¼æ–¹æ¡ˆ**:
  - Tailwind CSS (ä¸»è¦æ¨£å¼)
  - SCSS (ç´°ç·» UI èª¿æ•´)
  - ShadCN/UI (çµ„ä»¶åº«)
- **èº«ä»½é©—è­‰**: Clerk
- **è³‡æ–™ç²å–**: Convex (å…§å»ºå³æ™‚æŸ¥è©¢)

### å¾Œç«¯èˆ‡è³‡æ–™åº«

- **å¾Œç«¯å³æœå‹™**: Convex
  - å³æ™‚è³‡æ–™åº«
  - æª”æ¡ˆå„²å­˜
  - å³æ™‚å”ä½œ
  - èº«ä»½é©—è­‰æ•´åˆ
- **AI æœå‹™**: Google Gemini API
- **æª”æ¡ˆè™•ç†**: PDF.js, PDF-lib
- **æœå°‹æœå‹™**: Convex å…§å»ºæœå°‹

### é–‹ç™¼èˆ‡ç¶­è­·å·¥å…·

#### é—œæ–¼ TanStack Query:

**å»ºè­°**: ä¸éœ€è¦ä½¿ç”¨ TanStack Query
**åŸå› **:

- Convex æä¾›å…§å»ºçš„å³æ™‚æŸ¥è©¢å’Œå¿«å–
- é¿å…é›™é‡æŠ½è±¡å±¤
- Convex çš„ useQuery hook å·²ç¶“è™•ç†äº†å¿«å–ã€è¼‰å…¥ç‹€æ…‹ã€éŒ¯èª¤è™•ç†
- æ¸›å°‘åŒ…å¤§å°å’Œè¤‡é›œåº¦

#### é—œæ–¼ Sentry:

**å¼·çƒˆå»ºè­°**: å¿…é ˆæ•´åˆ Sentry
**åŸå› **:

- ä¸€äººé–‹ç™¼åœ˜éšŠæ›´éœ€è¦å®Œå–„çš„éŒ¯èª¤ç›£æ§
- æå‰ç™¼ç¾å’Œä¿®å¾©ç”¨æˆ¶é‡åˆ°çš„å•é¡Œ
- æ•ˆèƒ½ç›£æ§å¹«åŠ©å„ªåŒ–ç”¨æˆ¶é«”é©—
- ç™¼å¸ƒè¿½è¹¤å¹«åŠ©å•é¡Œå®šä½

**Sentry é…ç½®**:

```javascript
// sentry.client.config.ts
import { init } from "@sentry/nextjs";

init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
  integrations: [
    // PDF è™•ç†éŒ¯èª¤ç›£æ§
    // AI API èª¿ç”¨ç›£æ§
    // æª”æ¡ˆä¸Šå‚³éŒ¯èª¤è¿½è¹¤
  ],
});
```

### SEO å„ªåŒ–ç­–ç•¥ (é‡å°ç´è¥¿è˜­å’Œæ¾³æ´²å¸‚å ´)

#### ç›®æ¨™å¸‚å ´è¨­å®š:

- **ä¸»è¦å¸‚å ´**: New Zealand, Australia
- **èªè¨€**: English (AU/NZ spelling - "colour", "centre", "organise")
- **æ™‚å€**: NZST/AEDT
- **è²¨å¹£**: NZD/AUD

#### æŠ€è¡“ SEO:

- **Next.js 16 å„ªå‹¢**: Built-in SEO optimisation
- **Metadataç®¡ç†**: Dynamic page titles and descriptions
- **Structured Data**: JSON-LD markup for construction industry
- **XML Sitemap**: Auto-generated sitemap.xml
- **Page Speed**: Turbopack optimisation for fast loading
- **Geo-targeting**: Set hreflang tags for AU/NZ regions
- **Local Schema**: LocalBusiness schema for NZ/AU presence

#### Content SEO Keywords (AU/NZ English):

**Primary Keywords:**

- "construction collaboration platform nz"
- "architectural drawing management australia"
- "RFI management software new zealand"
- "building consent document management"
- "construction project collaboration australia"

**Long-tail Keywords:**

- "architect drawing sharing software nz"
- "structural engineer collaboration tool australia"
- "construction detail library management"
- "building compliance software new zealand"
- "architectural RFI tracking australia"

**Industry-specific Terms:**

- "building consent process nz"
- "council submission documents australia"
- "architectural detail drawings library"
- "construction compliance documentation"

#### Content Marketing Strategy:

- Building Code compliance guides (NZ Building Code, BCA Australia)
- Council submission process tutorials
- NZ/AU construction regulation updates
- Local supplier compliance documentation
- Industry case studies from ANZ region
- Construction best practice articles

#### Technical Implementation:

```javascript
// app/layout.tsx - SEO Configuration for AU/NZ
export const metadata = {
  title: "Archidocky - Construction Collaboration Platform for NZ & Australia",
  description:
    "Professional construction project collaboration, drawing management and AI-powered RFI assistance for architects, engineers and construction professionals in New Zealand and Australia.",
  keywords: [
    "construction collaboration nz",
    "architectural drawing management australia",
    "RFI management software",
    "building consent documents",
    "construction project management",
  ],
  alternates: {
    canonical: "https://archidocky.com",
    languages: {
      "en-NZ": "https://archidocky.com/nz",
      "en-AU": "https://archidocky.com/au",
    },
  },
  openGraph: {
    title: "Archidocky - Construction Collaboration Platform",
    description:
      "Streamline construction projects with professional collaboration tools",
    images: ["/og-image.jpg"],
    locale: "en_NZ",
    alternateLocale: ["en_AU"],
  },
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
    },
  },
};
```

#### Local SEO Optimisation:

- Register on Google Business Profile (NZ & AU locations)
- List on local construction directories
- Partner with NZ/AU construction associations
- Target local construction forums and communities
- Build backlinks from NZ/AU construction websites

## ä½¿ç”¨è€…é«”é©—è¨­è¨ˆ

### è¨­è¨ˆåŸå‰‡

1. **å°ˆæ¥­ä¸”å‹å–„**: ç¬¦åˆå»ºç¯‰è¡Œæ¥­çš„å°ˆæ¥­éœ€æ±‚ï¼ŒåŒæ™‚ä¿æŒæ˜“ç”¨æ€§
2. **æ•ˆç‡å„ªå…ˆ**: æ¸›å°‘é»æ“Šæ¬¡æ•¸ï¼Œæä¾›å¿«æ·æ“ä½œ
3. **è³‡è¨Šæ¸…æ™°**: é‡è¦è³‡è¨Šçªå‡ºé¡¯ç¤ºï¼Œå±¤æ¬¡åˆ†æ˜
4. **å›æ‡‰å¼è¨­è¨ˆ**: æ”¯æ´æ¡Œæ©Ÿã€å¹³æ¿ã€æ‰‹æ©Ÿå¤šç¨®è¨­å‚™
5. **ç„¡éšœç¤™è¨­è¨ˆ**: ç¬¦åˆ WCAG æ¨™æº–

### æ ¸å¿ƒä½¿ç”¨æµç¨‹

#### æ–°ç”¨æˆ¶å•Ÿå‹•æµç¨‹:

1. **è¨»å†Š/ç™»å…¥** (Clerk è™•ç†)
2. **å…¬å¸è³‡è¨Šè¨­å®š** - å…¬å¸åç¨±ã€è¡Œæ¥­é¡å‹ã€åœ˜éšŠè¦æ¨¡
3. **è§’è‰²é¸æ“‡** - å»ºç¯‰å¸«ã€å·¥ç¨‹å¸«ã€å­¸ç”Ÿç­‰
4. **å¼•å°æ•™å­¸** - äº’å‹•å¼åŠŸèƒ½ä»‹ç´¹
5. **é¦–å€‹é …ç›®å»ºç«‹** - ç¯„ä¾‹é …ç›®å¿«é€Ÿä¸Šæ‰‹

#### æ—¥å¸¸å·¥ä½œæµç¨‹:

1. **å„€è¡¨æ¿æ¦‚è¦½** - å¾…è¾¦äº‹é …ã€æœ€æ–°æ›´æ–°ã€é‡è¦é€šçŸ¥
2. **é …ç›®é¸æ“‡** - å¿«é€Ÿåˆ‡æ›ä¸åŒé …ç›®
3. **æ–‡æª”æ“ä½œ** - ä¸Šå‚³ã€æª¢è¦–ã€æ¨™è¨»ã€åˆ†äº«
4. **AI è¼”åŠ©** - å•é¡Œè«®è©¢ã€æ–‡æª”åˆ†æ
5. **å”ä½œäº’å‹•** - è©•è«–ã€è¨è«–ã€é€šçŸ¥

### UI/UX è¨­è¨ˆæ–¹å‘

#### è‰²å½©ç³»çµ± - ç”¨æˆ¶è‡ªè¨‚ä¸»é¡Œ (User-Customizable Theming)

**è¨­è¨ˆç†å¿µ**: è®“ç”¨æˆ¶å®Œå…¨æŒæ§è¦–è¦ºé«”é©—ï¼Œæä¾›å°ˆæ¥­ä¸”å€‹æ€§åŒ–çš„å·¥ä½œç’°å¢ƒ

**åŠŸèƒ½ç‰¹æ€§**:

- ç”¨æˆ¶å¯è‡ªç”±é¸æ“‡æ–‡å­—é¡è‰²å’ŒèƒŒæ™¯é¡è‰²
- æä¾›å®Œæ•´çš„è‰²å½©é¸æ“‡å™¨ (Full Color Palette)
- ç³»çµ±è‡ªå‹•è¨ˆç®—å°æ¯”åº¦ç¢ºä¿å¯è®€æ€§
- æ™ºèƒ½ç”Ÿæˆä¸­æ€§è‰²éš
- å³æ™‚é è¦½ä¸»é¡Œæ•ˆæœ

**é è¨­ä¸»é¡Œé…ç½®**:

**1. ç¶“å…¸é»‘ç™½ä¸»é¡Œ (Default Light)**

```javascript
const classicLight = {
  background: "#FFFFFF",
  text: "#000000",
  primary: "#2563EB", // ç”¨æˆ¶å¯ä¿®æ”¹
  secondary: "#F59E0B", // ç”¨æˆ¶å¯ä¿®æ”¹
  // è‡ªå‹•è¨ˆç®—çš„ä¸­æ€§è‰²
  neutral: {
    50: "#F9FAFB",
    100: "#F3F4F6",
    200: "#E5E7EB",
    300: "#D1D5DB",
    400: "#9CA3AF",
    500: "#6B7280",
    600: "#4B5563",
    700: "#374151",
    800: "#1F2937",
    900: "#111827",
  },
};
```

**2. æ·±è‰²ä¸»é¡Œ (Dark Theme)**

```javascript
const classicDark = {
  background: "#0F172A",
  text: "#F8FAFC",
  primary: "#3B82F6",
  secondary: "#F59E0B",
  // è‡ªå‹•åè½‰è¨ˆç®—ä¸­æ€§è‰²
};
```

**æ™ºèƒ½è‰²å½©ç³»çµ±ç®—æ³•**:

**1. å°æ¯”åº¦æª¢æŸ¥ (WCAG AAA)**

```typescript
// lib/theme/contrast-checker.ts
function calculateContrast(bg: string, text: string): number {
  // WCAG å°æ¯”åº¦è¨ˆç®—
  const ratio = getContrastRatio(bg, text);
  return ratio;
}

function ensureReadability(bg: string, text: string): string {
  const ratio = calculateContrast(bg, text);

  // WCAG AAA è¦æ±‚: 7:1
  if (ratio < 7) {
    // è‡ªå‹•èª¿æ•´æ–‡å­—é¡è‰²ç›´åˆ°é”æ¨™
    return adjustTextColor(bg, text, 7);
  }
  return text;
}
```

**2. ä¸­æ€§è‰²è‡ªå‹•ç”Ÿæˆ**

```typescript
// lib/theme/neutral-generator.ts
function generateNeutralScale(background: string, text: string) {
  // åŸºæ–¼èƒŒæ™¯è‰²å’Œæ–‡å­—è‰²ï¼Œç”Ÿæˆ 10 ç´šç°éš
  const bgHSL = hexToHSL(background);
  const textHSL = hexToHSL(text);

  const neutrals = {};
  for (let i = 50; i <= 900; i += 50) {
    // æ’å€¼è¨ˆç®—æ¯å€‹è‰²éš
    const lightness = interpolate(bgHSL.l, textHSL.l, i / 1000);
    neutrals[i] = hslToHex({
      h: bgHSL.h,
      s: Math.min(bgHSL.s, 10), // ä½é£½å’Œåº¦
      l: lightness,
    });
  }

  return neutrals;
}
```

**3. ä¸»è‰²èª¿èˆ‡è¼”åŠ©è‰²æ‡‰ç”¨**

```typescript
// lib/theme/color-roles.ts
interface ThemeColors {
  // ç”¨æˆ¶é¸æ“‡
  background: string;
  text: string;
  primary: string; // ä¸»è¦æ“ä½œã€é€£çµ
  secondary: string; // æ¬¡è¦æ“ä½œ

  // è‡ªå‹•ç”Ÿæˆ
  neutral: NeutralScale;

  // åŠŸèƒ½æ€§é¡è‰²ï¼ˆåŸºæ–¼ä¸»è‰²èª¿ï¼‰
  success: string; // å¾ primary æ´¾ç”Ÿ
  warning: string; // å¾ secondary æ´¾ç”Ÿ
  error: string; // å¾ secondary æ´¾ç”Ÿ
  info: string; // å¾ primary æ´¾ç”Ÿ
}
```

**ä¸»é¡Œç·¨è¼¯å™¨ UI**:

```tsx
// components/theme-editor.tsx
<ThemeEditor>
  <ColorPicker
    label="Background Colour"
    value={theme.background}
    onChange={handleBackgroundChange}
    fullPalette={true}
  />

  <ColorPicker
    label="Text Colour"
    value={theme.text}
    onChange={handleTextChange}
    fullPalette={true}
  />

  <ContrastIndicator ratio={contrastRatio} />

  <ColorPicker
    label="Primary Colour"
    value={theme.primary}
    onChange={handlePrimaryChange}
  />

  <ColorPicker
    label="Secondary Colour"
    value={theme.secondary}
    onChange={handleSecondaryChange}
  />

  <ThemePreview theme={currentTheme} />

  <NeutralScalePreview neutrals={generatedNeutrals} />
</ThemeEditor>
```

**å„²å­˜èˆ‡æ‡‰ç”¨**:

```typescript
// ä¿å­˜åˆ°ç”¨æˆ¶è¨­å®š
await convex.mutation.users.updateTheme({
  userId: user.id,
  theme: customTheme,
});

// CSS Variables å‹•æ…‹æ‡‰ç”¨
document.documentElement.style.setProperty("--color-bg", theme.background);
document.documentElement.style.setProperty("--color-text", theme.text);
document.documentElement.style.setProperty("--color-primary", theme.primary);
// ... å…¶ä»–è®Šæ•¸
```

**Tailwind æ•´åˆ**:

```javascript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      colors: {
        // ä½¿ç”¨ CSS è®Šæ•¸ä»¥æ”¯æ´å‹•æ…‹ä¸»é¡Œ
        background: "var(--color-bg)",
        text: "var(--color-text)",
        primary: {
          DEFAULT: "var(--color-primary)",
          50: "var(--color-primary-50)",
          // ... è‡ªå‹•ç”Ÿæˆçš„è‰²éš
        },
        neutral: {
          50: "var(--color-neutral-50)",
          // ... è‡ªå‹•ç”Ÿæˆçš„ 10 ç´šç°éš
        },
      },
    },
  },
};
```

**é è¨­ä¸»é¡Œåº«**:

- Classic Light
- Classic Dark
- Ocean Blue
- Forest Green
- Sunset Orange
- Professional Grey
- High Contrast (Accessibility)

#### çµ„ä»¶è¨­è¨ˆ:

- **å¡ç‰‡å¼ä½ˆå±€**: è³‡è¨Šæ¨¡çµ„åŒ–å‘ˆç¾
- **è¡¨æ ¼è¨­è¨ˆ**: æ¸…æ™°çš„è³‡æ–™å‘ˆç¾å’Œæ“ä½œ
- **è¡¨å–®è¨­è¨ˆ**: åˆ†æ­¥é©Ÿè¡¨å–®ï¼Œæ¸›å°‘èªçŸ¥è² æ“”
- **å°èˆªè¨­è¨ˆ**: å´é‚Šæ¬„ + éºµåŒ…å±‘å°èˆª

## é–‹ç™¼éšæ®µè¦åŠƒ

### Phase 1: åŸºç¤å»ºè¨­ (4-6 é€±)

- [ ] å°ˆæ¡ˆæ¶æ§‹æ­å»º
- [ ] Clerk èº«ä»½é©—è­‰æ•´åˆ
- [ ] Convex è³‡æ–™åº«è¨­è¨ˆ
- [ ] åŸºç¤ UI çµ„ä»¶å»ºç«‹
- [ ] Sentry éŒ¯èª¤ç›£æ§æ•´åˆ

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (8-10 é€±)

- [ ] å…¬å¸åœ–åº«ç®¡ç†ç³»çµ±
- [ ] React-PDF æ•´åˆèˆ‡åŸºç¤ PDF æª¢è¦–åŠŸèƒ½
- [ ] æª”æ¡ˆä¸Šå‚³ä¸‹è¼‰ç³»çµ±
- [ ] ç”¨æˆ¶è§’è‰²æ¬Šé™ç®¡ç†
- [ ] åŸºç¤æœå°‹åŠŸèƒ½

### Phase 3: å”ä½œåŠŸèƒ½ (6-8 é€±)

- [ ] PDF æ¨™è¨»ç³»çµ± (åŸºæ–¼ Convex + Canvas)
- [ ] å³æ™‚å”ä½œåŠŸèƒ½ (Convex Real-time)
- [ ] ç‰ˆæœ¬æ§åˆ¶ç³»çµ±
- [ ] é€šçŸ¥ç³»çµ±
- [ ] è©•è«–è¨è«–åŠŸèƒ½

### Phase 4: AI æ•´åˆ (8-10 é€±)

- [ ] Gemini API æ•´åˆ
- [ ] æ–‡æª”åˆ†æåŠŸèƒ½
- [ ] RFI æ™ºèƒ½è™•ç†
- [ ] æ³•è¦çŸ¥è­˜åº«å»ºç«‹
- [ ] AI å•ç­”ç³»çµ±
- [ ] **è©•ä¼° Nutrient SDK å‡ç´š** (åŸºæ–¼ç”¨æˆ¶åé¥‹å’Œéœ€æ±‚)

### Phase 5: ç¤¾ç¾¤åŠŸèƒ½ (4-6 é€±)

- [ ] RFI è«–å£‡ç³»çµ±
- [ ] ç”¨æˆ¶äº’å‹•åŠŸèƒ½
- [ ] å…§å®¹å¯©æ ¸ç³»çµ±
- [ ] ç¤¾ç¾¤ç®¡ç†å·¥å…·

### Phase 6: å„ªåŒ–èˆ‡ä¸Šç·š (4-6 é€±)

- [ ] æ•ˆèƒ½å„ªåŒ–
- [ ] SEO å¯¦æ–½
- [ ] å®‰å…¨æ€§åŠ å›º
- [ ] ä½¿ç”¨è€…æ¸¬è©¦
- [ ] æ­£å¼ä¸Šç·šéƒ¨ç½²

## å•†æ¥­æ¨¡å¼è€ƒé‡

### æ”¶è²»ç­–ç•¥:

1. **å…è²»ç‰ˆ**: åŸºç¤åŠŸèƒ½ï¼Œæª”æ¡ˆæ•¸é‡é™åˆ¶ é™åˆ¶ AI ä½¿ç”¨é¡åº¦
2. **å°ˆæ¥­ç‰ˆ**: å®Œæ•´åŠŸèƒ½ï¼Œç„¡é™æª”æ¡ˆï¼Œç„¡é™åˆ¶ AI ä½¿ç”¨é¡åº¦
3. **æ•™è‚²ç‰ˆ**: å®Œæ•´åŠŸèƒ½ï¼Œæ¯å€‹ç”¨æˆ¶3ä»½æª”æ¡ˆï¼Œç„¡é™ç”¨æˆ¶ï¼Œå­¸æ ¡ä¸€æ¬¡ä»˜ä¸€å­¸å¹´çš„è²»ç”¨ï¼Œå­¸ç”Ÿä¸ç”¨ä»˜è²»ï¼Œå­¸æ ¡ç®¡ç†å­¸ç”Ÿçš„å¸³è™Ÿå’Œå¯†ç¢¼ï¼Œé™åˆ¶AI ä½¿ç”¨é¡åº¦
4. **å»£å‘Šæ”¶å…¥**: å»ºç«‹å»£å‘Šå°ˆç”¨çš„é é¢ï¼Œé¡ä¼¼Pinterestç¶²ç«™ï¼Œç”¨subscriptionæ”¶è²»

### ç›®æ¨™æŒ‡æ¨™:

- **ç”¨æˆ¶è¨»å†Š**: ç¬¬ä¸€å¹´ 1000+ å°ˆæ¥­ç”¨æˆ¶
- **æ´»èºåº¦**: æœˆæ´»èºç‡ 60%+
- **ä»˜è²»è½‰æ›**: 15%+ ä»˜è²»è½‰æ›ç‡
- **å®¢æˆ¶æ»¿æ„åº¦**: NPS è©•åˆ† 50+

## é¢¨éšªè©•ä¼°èˆ‡å°ç­–

### æŠ€è¡“é¢¨éšª:

- **AI API æˆæœ¬**: å¯¦æ–½ä½¿ç”¨é‡ç›£æ§å’Œå„ªåŒ–
- **æª”æ¡ˆå„²å­˜æˆæœ¬**: CDN å„ªåŒ–å’Œæª”æ¡ˆå£“ç¸®
- **æ“´å±•æ€§å•é¡Œ**: Convex è‡ªå‹•æ“´å±•ï¼ŒæŒ‰éœ€ä»˜è²»

### å•†æ¥­é¢¨éšª:

- **å¸‚å ´æ¥å—åº¦**: æ—©æœŸç”¨æˆ¶åé¥‹å’Œå¿«é€Ÿè¿­ä»£
- **ç«¶çˆ­å°æ‰‹**: å·®ç•°åŒ–åŠŸèƒ½å’Œç”¨æˆ¶é«”é©—å„ªå‹¢
- **æ³•è¦éµå¾ª**: è³‡æ–™å®‰å…¨å’Œéš±ç§ä¿è­·

## æˆåŠŸè¡¡é‡æ¨™æº–

### ç”¢å“æŒ‡æ¨™:

- [ ] ç”¨æˆ¶ç•™å­˜ç‡ > 70% (30 å¤©)
- [ ] åŠŸèƒ½ä½¿ç”¨ç‡ > 60% (æ ¸å¿ƒåŠŸèƒ½)
- [ ] éŒ¯èª¤ç‡ < 1% (Sentry ç›£æ§)
- [ ] é é¢è¼‰å…¥é€Ÿåº¦ < 3 ç§’

### å•†æ¥­æŒ‡æ¨™:

- [ ] æœˆç‡Ÿæ”¶æˆé•·ç‡ > 20%
- [ ] å®¢æˆ¶ç”Ÿå‘½é€±æœŸåƒ¹å€¼ > ç²å®¢æˆæœ¬ 3 å€
- [ ] å“ç‰ŒçŸ¥ååº¦åœ¨ç›®æ¨™ç¾¤é«”ä¸­ > 30%

---

**ç¸½çµ**: Archidocky v1 å°‡æˆç‚ºå»ºç¯‰è¡Œæ¥­æ•¸ä½è½‰å‹çš„é‡è¦å·¥å…·ï¼Œé€éå‰µæ–°çš„æŠ€è¡“æ•´åˆå’Œç”¨æˆ¶é«”é©—è¨­è¨ˆï¼Œè§£æ±ºè¡Œæ¥­ç—›é»ï¼Œå‰µé€ å•†æ¥­åƒ¹å€¼ã€‚

**ä¸‹ä¸€æ­¥**: ç­‰å¾… UI/UX è¨­è¨ˆç¨¿ï¼Œé–‹å§‹ Phase 1 é–‹ç™¼å·¥ä½œã€‚
